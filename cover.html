<!DOCTYPE html>
<!-- Displays detailed information on a single cover. Allows OCD metric execution. -->
<html>
    <head>
        <title>OCD - Cover</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="CSS/layout.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="//npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
        <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="JS/contentHandler.js"></script>
        <script src="node_modules/js-base64/base64.js"></script>
        <script src="JS/ServiceAPI/moduleHelper.js"></script>
        <script src="JS/ServiceAPI/serviceAPI.js"></script>
        <script src="JS/requestHandler.js"></script>
        <script src="JS/coverTableHandler.js"></script>
        <script src="node_modules/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
        <script src="node_modules/jquery.panzoom/dist/jquery.panzoom.min.js"></script>
        <script src="node_modules/jquery.mousewheel/jquery.mousewheel.js"></script>
        <script src="node_modules/force-graph/dist/force-graph.min.js"></script>
        <script src="node_modules/3d-force-graph/dist/3d-force-graph.min.js"></script>
        <script src="node_modules/arangojs/lib/web.js"></script>
        <script src="node_modules/file-saver/dist/FileSaver.min.js"></script>
        <script type="text/javascript">
            /* Id of the corresponding graph */
            var graphId = getUrlVar("graphId");
            /* Id of the cover */
            var coverId = getUrlVar("coverId");
            /* Meta Data Xml */
            var coverMetaXml;
            /* Meta Data Xmls of corresponding ground truth candidates (for metric execution) */
            var groundTruthMetasXml;
//            var coverDefaultXml;
            /* Graph structure in JSON format */
            var jsonGraph;
            var forceGraph;
            var have3D;
            var nodeName = "";
            var keysPressed = new Map();
            var rightClickLink = null;

            /* Database Information */
            var arangoUser = localStorage.getItem("arangoUser@WebOCD");
            var arangoPass = localStorage.getItem("arangoPass@WebOCD");
            var arangoDataBase = localStorage.getItem("arangoDataBase@WebOCD");
            var arangoCollection = localStorage.getItem("arangoCollection@WebOCD");

            //Testserver: http://ocd-web-client.duckdns.org:7071
            //Server ginkgo from rwth: http://ginkgo.informatik.rwth-aachen.de:8529
            const db = new arangojs.Database('http://127.0.0.1:8529');

            /* SVG for Visualization */
            var visualization;
            /* Maximum ground truth candidates (for metric execution) displayed per page */
            var COVERS_PER_PAGE = 20;
            /* Current page of ground truth candidates (for metric execution) */
            var pageNumber = 0;
            /* Default select option value */
            var selectOptionVal = "SELECT";
            /* Default select option code */
            var selectOptionStr = '<option value=' + selectOptionVal + '>--SELECT--</option>';
            /* Metric names */
            var metricNames;
            $(document).ready(function() {
                /* Identifiers for meta information to be displayed */
                var cells = ["Name", "Graph", "CreationMethod", "Communities", "R", "S"];
                /* Requests cover meta information */
                sendRequest("get", "covers/" + coverId + "/graphs/" + graphId + "?outputFormat=META_XML", "",
                    /* Response handler */
                    function(response) {
                        /*
                         * Init meta table
                         */
                        coverMetaXml = response;
                        appendCoverRow($('#coverMetaTable'), coverMetaXml, cells);
                        /*
                        * Init run metric collapsable
                        */
                       $("#metricType").append(
                           selectOptionStr
                           + '<option value="statistical">Statistical Measure</option>'
                           + '<option value="knowledgedriven">Knowledge Driven Measure</option>'
                        );
                        /*
                        * Init metrics table
                        */
                       $(coverMetaXml).find("Metric").each(function() {
                           var name = $(this).find('Type');
                           name = parseEnumName(name.text());
                           var status = $(this).find('Status').text();
                           if(status === 'COMPLETED') {
                               status = '<img class="icon" src="IMG/open-iconic/svg/check.svg" alt="y">';
                           }
                           else {
                               status = '<img class="icon" src="IMG/open-iconic/svg/x.svg" alt="y">';
                           }
                           var value = parseFloat($(this).find('Value').text());
                           value = value.toFixed(4);
                           /* Create table row */
                           var row = '<tr>'
                               + '<td>' + name + '</td>'
                               + '<td>' + status + '</td>'
                               + '<td>' + value + '</td>'
                               + '</tr>';
                           $("#metricsTable tbody").append(row);
                       });
                        /*
                         * Register events/components
                         */
                        registerCoverTable();
                        //registerCollapsable("#metricsCollapsable", metricsCollapsableHandler);
                        registerCollapsable("#metricsCollapsable");
                        registerCollapsable("#visualizationCollapsable", visualizationCollapsableHandler);
                        registerCollapsable("#runMetricCollapsable");
                        registerParameterSelect("#metric", "#metricParameterRow", getMetricParameters);
                    },
                    /* Error handler */
                    function(errorData) {
                        /*
                         * Cover request failed
                         */
                        showConnectionErrorMessage("Cover was not received.", errorData);
                    }, "text");
                /*
                 * Submit listener for the run metric form.
                 */
                $('#runMetricForm').submit(function(){
                    if($("#metricType").val() === selectOptionVal) {
                        showErrorMessage('Please select a metric type.');
                        return;
                    }
                    else if($("#metric").val() === selectOptionVal) {
                        showErrorMessage('Please select a metric.');
                        return;
                    }
                    if($("#metricType").val() === "knowledgedriven") {
                        var coverId = $("input[name='coverSelect']:checked").val();
                        if(typeof coverId === 'undefined') {
                            showErrorMessage('Please select a ground truth cover.');
                            return;
                        }
                        /* Request knowledge driven measure execution */
                        else {
                            runKnowledgeDrivenMeasure();
                        }
                    }
                    else if($("#metricType").val() === "statistical") {
                        /* Request statistical measure execution */
                        runStatisticalMeasure();
                    }
                    else {
                        /* Should not happen */
                        showErrorMessage('Client Error.');
                        return;
                    }
                });
                /*
                 * Change listener for the metric type in the run metric form.
                 * Executed when a new metric type is selected.
                 */
                $("#metricType").change(function() {
                    $("#metric").empty();
                    /* Hides ground truth covers */
                    $(".selectorWrapper").css("display", "none");
                    $("#metricType option:selected").each(function() {
                        /* A real metric (i.e. not the default option) is selected */
                        if($(this).val() !== selectOptionVal) {
                            getMetrics(function() {
                                $("#metric").append(selectOptionStr);
                                $(metricNames).find('Name').each(function() {
                                    $("#metric").append(
                                        '<option value="' + $(this).text()
                                        + '">' + parseEnumName($(this).text()) + '</option>');
                                });
                            });
                            if($(this).val() === "knowledgedriven") {
                                /* Displays ground truth covers */
                                loadCoverTable();
                                $(".selectorWrapper").css("display", "block");
                            }
                            else if($(this).val() === "statistical") {
                            }
                            else {
                                showErrorMessage("Client Error");
                            }
                            $("#objectCreatorRow").css("display", "table-row");
                        }
                        else {
                            $("#objectCreatorRow").css("display", "none");
                        }
                    });
                });
            });
            /* Requests the execution of a knowledge driven measure */
            function runKnowledgeDrivenMeasure() {
                var groundTruthId = $("input[name='coverSelect']:checked").val();
                var params = getParameterXml("#metricParams");
                sendRequest("post", "covers/" + coverId + "/graphs/" + graphId +
                        "/metrics/knowledgedriven/groundtruth/"
                        + groundTruthId + "?metricType=" + $('#metric').val(), params,
                        /* Response handler */
                        function(response) {
                            window.location.href = "index.html";
                        },
                        /* Error handler */
                        function(errorData) {
                            /*
                             * Run metric request failed
                             */
                            showConnectionErrorMessage("Metric request failed.", errorData);
                        });
            }
            /* Requests the execution of a statistical measure */
            function runStatisticalMeasure() {
                var params = getParameterXml("#metricParams");
                sendRequest("post", "covers/" + coverId + "/graphs/" + graphId
                        + "/metrics/statistical?metricType=" + $('#metric').val()
                        , params,
                        /* Response handler */
                        function(response) {
                            window.location.href = "index.html";
                        },
                        /* Error handler */
                        function(errorData) {
                            /*
                             * Run metric request failed
                             */
                            showConnectionErrorMessage("Metric request failed.", errorData);
                        });
            }
            /* Requests and stores the names of the parameters of a given metric
             * Then executes a callback function */
            function getMetricParameters(metricName, callback) {
                sendRequest("get", "metrics/" + metricName + "/parameters/default", "",
                        /* Response handler */
                        function(response) {
                            if(typeof callback !== 'undefined') {
                                callback(response);
                            }
                        },
                        /* Error handler */
                        function(errorData) {
                            /*
                             * GraphIds request failed
                             */
                            showConnectionErrorMessage("Metric parameters were not received.", errorData);
                        });
            }
            /* Requests and stores the names of all metrics (of a certain metric type)
             * Then executes a callback function */
            function getMetrics(callback) {
                sendRequest("get", "metrics/" + $("#metricType").val(), "",
                        /* Response handler */
                        function(response) {
                            metricNames = response;
                            if(typeof callback !== 'undefined') {
                                callback();
                            }
                        },
                        /* Error handler */
                        function(errorData) {
                            /*
                             * Request failed
                             */
                            showConnectionErrorMessage("Metric names were not received.", errorData);
                        });
            }
            /* Requests a potential ground truth covers and adds them to a table */
            function loadCoverTable() {
                /* Initializes table */
                $('#coverTable tbody').empty();
                $('.pageNumWrapper').empty();
                $('.pageNumWrapper').append(pageNumber);
                var firstIndex = COVERS_PER_PAGE * pageNumber;
                /* Identifiers of the information to be displayed */
                var cells = ["Name", "Graph", "CreationMethod", "Communities", "C", "Select"];
                /* Requests the covers */
                sendRequest("get", "covers?graphId=" + graphId + "&executionStatuses=COMPLETED&includeMeta=TRUE&firstIndex=" + firstIndex + "&length=" + COVERS_PER_PAGE , "",
                    /* Response handler */
                    function(groundTruthMetasXml) {
                        /*
                         * CoverMetas request succeeded
                         */
                        if($(groundTruthMetasXml).find("Id").length === 0 && pageNumber > 0) {
                            pageNumber--;
                            loadCoverTable();
                        }
                        /* Adds each cover to the table */
                        $(groundTruthMetasXml).find("Cover").each(function() {
                            appendCoverRow($('#coverTable'), $(this), cells);
                        });
                            /*
                             * Sort Table
                             */
                            try {
                                $("#coverTable").tablesorter({sortList: [[0,0]],
                                    headers: { 6: {sorter: false}, 7: {sorter: false}}});
                            } catch(err) { /* table empty */ }
                    },
                    /* Error handler */
                    function(errorData) {
                        /*
                         * Ground truth cover request failed
                         */
                        showConnectionErrorMessage("Ground truth cover metas were not received.", errorData);
                });
                /* Listener to show the next page of ground truth covers */
                $('.pageLeft').click(function(){
                    if(pageNumber > 0) {
                        pageNumber--;
                        loadCoverTable();
                    }
                });
                /* Listener to show the previous page of ground truth covers */
                $('.pageRight').click(function(){
                    pageNumber++;
                    loadCoverTable();
                });
            }
//            function metricsCollapsableHandler() {
//                if(typeof coverDefaultXml === 'undefined') {
//                    getDefaultXml(function() {
//                            /*
//                             * Init metrics table
//                             */
//                            $(coverDefaultXml).find("Metric").each(function() {
//                                var name = $(this).find('Type');
//                                name = parseEnumName(name.text());
//                                var status = $(this).find('Status').text();
//                                if(status === 'COMPLETED') {
//                                    status = '<img class="icon" src="IMG/open-iconic/svg/check.svg" alt="y">';
//                                }
//                                else {
//                                    status = '<img class="icon" src="IMG/open-iconic/svg/x.svg" alt="y">';
//                                }
//                                var value = parseFloat($(this).find('Value').text());
//                                value = value.toFixed(4);
//                                var row = '<tr>'
//                                    + '<td>' + name + '</td>'
//                                    + '<td>' + status + '</td>'
//                                    + '<td>' + value + '</td>'
//                                    + '</tr>';
//                                $("#metricsTable tbody").append(row);
//                            });
//                        });
//                }
//            }
            /* Requests the default / general information about the cover
             * Then executes a callback function */
            function getDefaultXml(callback) {
                /* Sends a request for the cover information */
                sendRequest("get", "covers/" + coverId + "/graph/" + graphId + "/outputFormat/DEFAULT_XML", "",
                    /* Response handler */
                    function(response) {
                        coverDefaultXml = response;
                        if(typeof callback !== 'undefined') {
                            callback();
                        }
                    },
                    /* Error handler */
                    function(errorData) {
                        /*
                         * GraphIds request failed
                         */
                        showConnectionErrorMessage("Cover was not received.", errorData);
                    }, "text");
            }

            /* Handles what happens on the visualization type Button presses */
            function buttonClick(number) {
                $(document).ready(function () {

                    let svgVizScroll = document.getElementById("visualizationZoomer");
                    let svgViz = document.getElementById("visualizationContent");
                    let forceViz = document.getElementById("forceVisualizationContent");

                    highlightNodes = new Set();
                    highlightLinks = new Set();

                    if (number === 0) {
                        forceViz.style.display = "none";

                        svgViz.style.display = "inherit";
                        svgVizScroll.style.display = "inline";
                    } else if (number === 1 || number === 2) {
                        forceViz.style.display = "inherit";
                        if (typeof forceGraph !== "undefined") {
                            forceGraph.width($('.forceVisualizationContent').width());
                            forceGraph.height($('.forceVisualizationContent').height());
                        }
                        svgViz.style.display = "none";
                        svgVizScroll.style.display = "none";

                        if (number === 1 && (have3D === true || typeof have3D === "undefined")) {
                            have3D = false;
                            //console.log("2D");
                            if (typeof forceGraph !== "undefined") {
                                forceGraph._destructor();
                            }
                            getJSON();
                        } else if (number === 2 && (have3D === false || typeof have3D === "undefined")) {
                            have3D = true;
                            //console.log("3D");
                            if (typeof forceGraph !== "undefined") {
                                forceGraph._destructor();
                            }
                            getJSON();
                        }
                    }
                })
            }

            /* Resizes the graph canvas on fullscreen close. Done in own eventListener to do it after the automatic resize of the containing div*/
            document.addEventListener('fullscreenchange', (event) => {
                // document.fullscreenElement will point to the element that
                // is in fullscreen mode if there is one. If there isn't one,
                // the value of the property is null.
                if (typeof document.fullscreenElement !== "undefined") {
                    var elem = document.getElementById('forceVisualizationContent');

                    if (typeof forceGraph !== "undefined") {
                        forceGraph.width($('.forceVisualizationContent').width());
                        forceGraph.height($('.forceVisualizationContent').height());
                    }
                }
            });

            /* Listener for Ctrl+C presses */
            document.addEventListener('keydown', (e) => {
                if(e.code === "KeyC" || e.code === "ControlLeft") {
                    keysPressed.set(e.code,true);
                }
            });

            /* Handles fullscreen events on press of the F key over a force graph and pressing enter for search, nodeSearch on enter, and nodeName copy on Ctrl+C */
            document.addEventListener('keyup', (e) => {
                if (e.code === "KeyF" && window.innerHeight !== screen.height && $('#forceVisualizationGraphic:hover').length !== 0 && document.getElementById("nodeSearchFormDropDown").classList.contains("show") === false && document.getElementById("toolsFormDropDown").classList.contains("show") === false)
                {
                    var elem = document.getElementById('forceVisualizationContent');

                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.mozRequestFullScreen) { /* Firefox */
                        elem.mozRequestFullScreen();
                    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) { /* IE/Edge */
                        elem.msRequestFullscreen();
                    }

                    if (typeof forceGraph !== "undefined") {
                        forceGraph.width(screen.width);
                        forceGraph.height(screen.height);
                    }
                }
                else if(e.code === "KeyF" && window.innerHeight === screen.height)
                {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) { /* Firefox */
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) { /* IE/Edge */
                        document.msExitFullscreen();
                    }
                }
                else if(e.code === "Enter")
                {
                    if(document.getElementById("nodeSearchFormDropDown").classList.contains("show") && document.activeElement === document.getElementById("nodeSearchForm")) {
                        nodeSearch();
                    }
                    else if(document.getElementById("toolsFormDropDown").classList.contains("show") && document.activeElement === document.getElementById("saveJsonForm")) {
                        saveJSON();
                    }
                }
                else if((e.code === "KeyC" || e.code === "ControlLeft") && $('#forceVisualizationGraphic:hover').length !== 0)
                {
                    if(keysPressed.get("KeyC") === true && keysPressed.get("ControlLeft") === true) {
                        if(document.getElementById("nodeSearchFormDropDown").classList.contains("show") === false) {
                            searchDropDown();
                        }

                        document.getElementById("nodeSearchForm").value = nodeName;
                        document.getElementById("nodeSearchForm").select();
                        document.execCommand("copy", false, document.getElementById("nodeSearchForm").value);
                    }
                    keysPressed.set(e.code, false);
                }
            });

            /* Opens the dropdown menu for entering database information */
            function databaseInfoDropDown() {
                // Close other menu
                let dropdowns = document.getElementsByClassName("nodeSearchFormDropDown");
                let i;
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
                dropdowns = document.getElementsByClassName("toolsFormDropDown");
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }

                document.getElementById("dataBaseDropDownContent").classList.toggle("show");
            }

            /* Opens the search bar for nodes */
            function searchDropDown() {
                document.getElementById("nodeSearchForm").style.backgroundColor = "#f1f1f1";
                document.getElementById("nodeSearchForm").placeholder = "Node Name";

                // Close other menu
                let dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
                let i;
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
                dropdowns = document.getElementsByClassName("toolsFormDropDown");
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }

                document.getElementById("nodeSearchFormDropDown").classList.toggle("show");
            }

            /* Opens the tool bar(s) */
            function toolsDropDownDots() {
                // Close other menus
                let dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
                let i;
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
                dropdowns = document.getElementsByClassName("nodeSearchFormDropDown");
                for (i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }

                document.getElementById("toolsFormDropDown").classList.toggle("show");
            }

            function databaseInfoSubmit() {
                arangoUser = $("#arangoUser").val();
                arangoPass = $("#arangoPass").val();
                arangoDataBase = $("#arangoDataBase").val();
                arangoCollection = $("#arangoCollection").val();

                localStorage.setItem("arangoUser@WebOCD",arangoUser);
                localStorage.setItem("arangoPass@WebOCD",arangoPass);
                localStorage.setItem("arangoDataBase@WebOCD",arangoDataBase);
                localStorage.setItem("arangoCollection@WebOCD",arangoCollection);

                var dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }

            // Close the dropdown menu if the user clicks outside of it
            window.onclick = function(event) {
                if (!event.target.matches('.dropDownOpenButton') && !event.target.matches('.dataBaseDropDownContentForm') && !event.target.matches('.nodeSearchForm') && !event.target.matches('.nodeSearchButton')
                    && !event.target.matches('.toolsDropDownDots')  && event.target.className !== 'tool-dot' && !event.target.matches('.saveJsonForm')){

                    var dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
                    var i;
                    for (i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                    dropdowns = document.getElementsByClassName("nodeSearchFormDropDown");
                    for (i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                    dropdowns = document.getElementsByClassName("toolsFormDropDown");
                    for (i = 0; i < dropdowns.length; i++) {
                        var openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            }

            /* Let the camera look at a specified node (if found) */
            function nodeSearch(){
                if (typeof forceGraph !== "undefined") {
                    let searchNodeName = $("#nodeSearchForm").val();

                    for(let node of forceGraph.graphData().nodes)
                    {
                        if(node.name === searchNodeName)
                        {
                            if(have3D === false) {
                                forceGraph.centerAt(node.x, node.y);
                                forceGraph.zoom(9, 200);
                                searchNodeName = undefined;
                            } else {
                                const distance = 40;
                                const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                                forceGraph.cameraPosition({ x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio}, node, 250);
                                searchNodeName = undefined;
                            }
                        }
                    }
                    if (typeof searchNodeName !== "undefined" && searchNodeName !== "") {
                        document.getElementById("nodeSearchForm").style.backgroundColor = "#e58c8c";
                        document.getElementById("nodeSearchForm").placeholder = "Not found";
                    } else {
                        document.getElementById("nodeSearchForm").style.backgroundColor = "#f1f1f1";
                        document.getElementById("nodeSearchForm").placeholder = "Node Name";

                        let  dropdowns = document.getElementsByClassName("nodeSearchFormDropDown");
                        for (let i = 0; i < dropdowns.length; i++) {
                            let openDropdown = dropdowns[i];
                            if (openDropdown.classList.contains('show')) {
                                openDropdown.classList.remove('show');
                            }
                        }
                    }
                    document.getElementById("nodeSearchForm").value = "";
                }
            }

            /* Save the Graph in JSON format */
            function saveJSON() {
                let fileName = $("#saveJsonForm").val();

                if(typeof jsonGraph === 'undefined') {
                    sendRequest("get", "visualization/cover/" + coverId + "/graph/" + graphId + "/outputFormat/JSON/layout/ORGANIC/paint/PREDEFINED_COLORS", "",
                        function (response) {
                            jsonGraph = response;
                            const blob = new Blob([jsonGraph],
                                { type: "application/json" });
                            saveAs(blob, fileName + ".json");
                        });
                }
                else {
                    const blob = new Blob([jsonGraph],
                        { type: "application/json" });
                    saveAs(blob, fileName + ".json");
                }

                let  dropdowns = document.getElementsByClassName("toolsFormDropDown");
                for (let i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }

            /* Builds a force graph from json data */
            function buildGraph() {
                var graph = JSON.parse(jsonGraph);
                var sizes = new Map();
                var colors = new Map();
                for (let node of graph.nodes) {
                    sizes[node.id] = node.size;
                    colors[node.id] = node.color;
                }

                if (have3D === false) {
                    forceGraph = ForceGraph()
                    (document.getElementById('forceVisualizationGraphic'))
                        .backgroundColor("#fafafa")
                        .graphData(graph)
                        .nodeId('id')
                        .nodeLabel('name')
                        .onNodeHover(node => {
                            if (node != null) {
                                nodeName = node.name;
                            }
                        })
                        .onNodeClick(node => {
                            if (arangoDataBase !== "" && arangoDataBase !== null
                                && arangoUser !== "" && arangoUser !== null
                                && arangoPass !== null
                                && arangoCollection !== "" && arangoCollection !== null) {

                                db.useDatabase(arangoDataBase);
                                db.useBasicAuth(arangoUser, arangoPass);
                                const docCollection = db.collection(arangoCollection);
                                docCollection.document(node.name, true).then(function (doc) {
                                    let nodeWindow = window.open("", '_blank');

                                    if (doc != null) {
                                        //console.log(JSON.stringify(doc, null, '    '));
                                        let docStr = JSON.stringify(doc, null, '    ');
                                        docStr = docStr.replace(/\n/g, "<br />");
                                        nodeWindow.document.write("<pre>" + docStr + "</pre>");
                                    } else {
                                        nodeWindow.document.write("<pre>" + "Object was not found" + "</pre>");
                                    }
                                }).catch((err) => console.error(err));
                            }
                        })
                        .nodeVal(function (node) {
                            return sizes[node.id] - 19
                        })
                        .nodeColor(function (node) {
                            return colors[node.id];
                        })
                        .onNodeDragEnd(node => {
                            node.fx = node.x;
                            node.fy = node.y;
                        })
                        .onNodeRightClick(node => {
                            //TODO: Seem a bit slow after restoring, check original forces/velocity
                            node.fx = null;
                            node.fy = null;
                        })
                        .linkSource('source')
                        .onLinkRightClick(link => {
                            if (link !== rightClickLink) {
                                rightClickLink = link;
                            } else {
                                rightClickLink = null;
                            }
                        })
                        .linkWidth(link => link === rightClickLink ? 2.5 : 1.5)
                        .linkColor(link => link === rightClickLink ? "rgba(145,217,65,0.6)" : "rgba(219,219,219,0.85)")
                        .linkDirectionalArrowLength(5)
                        .linkDirectionalArrowRelPos(1)
                        .linkTarget('target')
                        .cooldownTicks(200);
                } else {
                    forceGraph = ForceGraph3D()
                    (document.getElementById('forceVisualizationGraphic'))
                        .graphData(graph)
                        .nodeId('id')
                        .nodeLabel('name')
                        .onNodeHover(node => {
                            if (node != null) {
                                nodeName = node.name;
                            }
                        })
                        .onNodeClick(node => {
                            if (arangoDataBase !== "" && arangoDataBase !== null
                                && arangoUser !== "" && arangoUser !== null
                                && arangoPass !== null
                                && arangoCollection !== "" && arangoCollection !== null) {

                                db.useDatabase(arangoDataBase);
                                db.useBasicAuth(arangoUser, arangoPass);
                                const docCollection = db.collection(arangoCollection);
                                docCollection.document(node.name, true).then(function (doc) {
                                    let nodeWindow = window.open("", '_blank');

                                    if (doc != null) {
                                        //console.log(JSON.stringify(doc, null, '    '));
                                        let docStr = JSON.stringify(doc, null, '    ');
                                        docStr = docStr.replace(/\n/g, "<br />");
                                        nodeWindow.document.write("<pre>" + docStr + "</pre>");
                                    } else {
                                        nodeWindow.document.write("<pre>" + "Object was not found" + "</pre>");
                                    }
                                }).catch((err) => console.error(err));
                            }
                        })
                        .nodeVal(function (node) {
                            return sizes[node.id] - 19
                        })
                        .nodeColor(function (node) {
                            return colors[node.id];
                        })
                        .nodeOpacity(1)
                        .onNodeDragEnd(node => {
                            node.fx = node.x;
                            node.fy = node.y;
                            node.fz = node.z;
                        })
                        .onNodeRightClick(node => {
                            //TODO: Seem a bit slow after restoring, check original forces/velocity
                            node.fx = null;
                            node.fy = null;
                            node.fz = null;
                        })
                        .linkSource('source')
                        .onLinkRightClick(link => {
                            if (link !== rightClickLink) {
                                rightClickLink = link;
                            } else {
                                rightClickLink = null;
                            }
                            forceGraph
                                .linkColor(forceGraph.linkColor())
                                .linkWidth(forceGraph.linkWidth())
                        })
                        .linkOpacity(0.35)
                        .linkColor(link => link === rightClickLink ? "rgba(126,234,10,0.85)" : "#dedede")
                        .linkWidth(link => link === rightClickLink ? 2 : 0)
                        .linkDirectionalArrowLength(4)
                        .linkDirectionalArrowRelPos(1)
                        .linkTarget('target')
                        .cooldownTicks(200);
                }

                forceGraph.width($('.forceVisualizationContent').width());
                forceGraph.height($('.forceVisualizationContent').height());
            }

            /* Requests and stores a JSON representation of the graph and then builds it */
            function getJSON() {
                if(typeof jsonGraph === 'undefined') {
                    sendRequest("get", "visualization/cover/" + coverId + "/graph/" + graphId + "/outputFormat/JSON/layout/ORGANIC/paint/PREDEFINED_COLORS", "",
                        function (response) {
                            jsonGraph = response;
                            buildGraph();
                        },
                        /* Error handler */
                        function (errorData) {
                            /*
                         * GraphIds request failed
                         */
                            showConnectionErrorMessage("Visualization was not received.", errorData);
                        });
                }
                else {
                    buildGraph();
                }
            }

            /* Handles the collapsable element for the graph visualization */
            function visualizationCollapsableHandler() {
                /* Requests the graph visualization */
                if (typeof visualization === 'undefined') {
                    getVisualization();
                }

                /* Registers the visualization for panzoom */
                var $panzoom = $('body').find('.visualizationGraphic').panzoom({
                    $zoomRange: $('body').find(".visualizationZoomer"),
                    increment: 0.9,
                    contain: 'invert',
                    maxScale: 10,
                    minScale: 1
                });
                $panzoom.on('mousewheel', function (e) {
                    e.preventDefault();
                    var delta = e.delta || e.originalEvent.wheelDelta;
                    var zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
                    $panzoom.panzoom('zoom', zoomOut, {
                        increment: 0.1,
                        animate: false,
                        focal: e
                    });
                });
            }
            /* Requests and stores the visualization of the cover */
            function getVisualization() {
                /* Requests the visualization */
                sendRequest("get", "visualization/cover/" + coverId + "/graph/"
                        + graphId + "/outputFormat/SVG/layout/ORGANIC/paint/PREDEFINED_COLORS", "",
                    /* Response handler */
                    function(response) {
                        visualization = response;
                        $('.visualizationGraphic').append(visualization);
                    },
                    /* Error handler */
                    function(errorData) {
                        /*
                         * Visualization request failed
                         */
                        showConnectionErrorMessage("Visualization was not received.", errorData);
                });
            }
        </script>
    </head>
    <body>
        <div id="wrapper">
            <div id="contentWrapper">
                <div id="content">
                    <!-- Container for display of error messages -->
                    <div id="errorMessageWrapper">
                        <div id="errorMessage"></div>
                    </div>

                    <!-- Cover meta information table -->
                    <div id="coverHeader" class="col-sm-12 col-md-12 coverColor">

                    </div>

                    <div class="tableWrapper">
                        <table id="coverMetaTable">
                            <thead>
                            <tr>
                                <th class="hidden" title="CoverId"></th>
                                <th class="hidden" title="GraphId"></th>
                                <th width="300" title="Cover Name" class="sortable">
                                    Name
                                    <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                </th>
                                <th width="300" title="Graph Name" class="sortable">
                                    Graph
                                    <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                </th>
                                <th width="300" title="Algorithm Name" class="sortable">
                                    Creation Method
                                    <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                </th>
                                <th width="100" title="Community Count" class="sortable">
                                    Communities
                                    <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                </th>
                                <th width="20" title="Remove Cover">
                                    R
                                </th>
                                <th width="20" title="Save Cover">
                                    S
                                </th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Collapsable element for metric value display -->
                    <div id="metricsCollapsable" class="collapsable">
                        <div class="collapsableHeader">
                            <div class="collapsableTitle">Metrics</div>
                            <div class="collapsableCollapser">
                                <img class="icon iconBtn collapsableDisplayBtn" src="IMG/open-iconic/svg/chevron-bottom.svg" alt="d">
                                <img class="icon iconBtn collapsableCollapseBtn" src="IMG/open-iconic/svg/chevron-top.svg" alt="c">
                            </div>
                        </div>
                        <div class="collapsableContent">
                            <div class="tableWrapper table-responsive">
                                <table id="metricsTable" class="table">
                                    <thead>
                                    <tr>
                                        <th title="Metric Name">
                                            Metric
                                        </th>
                                        <th width="20" title="Completed">
                                            Completed
                                        </th>
                                        <th title="Metric Value">
                                            Value
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Collapsable element for metric execution -->
                    <div id="runMetricCollapsable" class="collapsable">
                        <div class="collapsableHeader">
                            <div class="collapsableTitle">Run Metric</div>
                            <div class="collapsableCollapser">
                                <img class="icon iconBtn collapsableDisplayBtn" src="IMG/open-iconic/svg/chevron-bottom.svg" alt="d">
                                <img class="icon iconBtn collapsableCollapseBtn" src="IMG/open-iconic/svg/chevron-top.svg" alt="c">
                            </div>
                        </div>
                        <div class="collapsableContent">
                            <div class="formWrapper">
                                <div class="formDiv">
                                    <form id="runMetricForm" class="parameterized" action="javascript:void(0); return false;">
                                        <div class="formContentWrapper">
                                            <table class="formTable">
                                                <tr>
                                                    <td>
                                                        Metric Type:
                                                    </td>
                                                    <td>
                                                        <select id="metricType" class="nonparameter">
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Metric:
                                                    </td>
                                                    <td>
                                                        <select id="metric" class="nonparameter">
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr id="metricParameterRow" class="hidden">
                                                    <td>
                                                        Parameters:
                                                    </td>
                                                    <td>
                                                        <div class="tableWrapper">
                                                            <table id="metricParams">
                                                                <thead>
                                                                    <tr>
                                                                        <th title="Parameter Name">Name</th>
                                                                        <th title="Default Value">Default</th>
                                                                        <th title="Use Non-Default Parameter">Value</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody></tbody>
                                                            </table>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="submitWrapper">
                                            <input name="submit" id="runMetricBtn" class="submit icon" type="image" src="IMG/open-iconic/svg/media-play.svg" alt="Run">
                                        </div>
                                        <div class="selectorWrapper hidden">
                                        <div class="selectorTitle">
                                            Select a Ground Truth Cover
                                        </div>
                                        <div class="selectorContent">
                                            <!-- Page control for ground truth cover table -->
                                            <div class = "pageControlWrapper">
                                                <div class="pageControl">
                                                    <div class="pageLeftWrapper">
                                                        <img class="icon iconBtn pageLeft" src="IMG/open-iconic/svg/chevron-left.svg" alt="r">
                                                    </div>
                                                    <div class = "pageNumWrapper">
                                                    </div>
                                                    <div class="pageRightWrapper">
                                                        <img class="icon iconBtn pageRight" src="IMG/open-iconic/svg/chevron-right.svg" alt="r">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Table for potential ground truth covers -->
                                            <div class="tableWrapper">
                                                <table id="coverTable">
                                                    <thead>
                                                    <tr>
                                                        <th class="hidden" title="CoverId"></th>
                                                        <th class="hidden" title="GraphId"></th>
                                                        <th width="300" title="Cover Name" class="sortable">
                                                            Name
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="300" title="Graph Name" class="sortable">
                                                            Graph
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="300" title="Algorithm Name" class="sortable">
                                                            Creation Method
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="100" title="Community Count" class="sortable">
                                                            Communities
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="20" title="Show Cover">
                                                            C
                                                        </th>
                                                        <th width="20" title="Select Graph">
                                                            Select
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Collapsable for cover visualization -->
                    <div id="visualizationCollapsable" class="collapsable">
                        <div class="collapsableHeader">
                            <div class="collapsableTitle">Visualization</div>
                            <div class="collapsableCollapser">
                                <img class="icon iconBtn collapsableDisplayBtn" src="IMG/open-iconic/svg/chevron-bottom.svg" alt="d">
                                <img class="icon iconBtn collapsableCollapseBtn" src="IMG/open-iconic/svg/chevron-top.svg" alt="c">
                            </div>
                        </div>
                        <div class="collapsableContent">
                            <div class="optionRow" style="width:100%">
                                <div class="dataBaseDropDown" style="width:10%">
                                    <button class="dropDownOpenButton" onclick="databaseInfoDropDown()">Database</button>
                                    <form method="post" id="dataBaseDropDownContent" class="dataBaseDropDownContent" type='button'>
                                        <input class="dataBaseDropDownContentForm" id="arangoUser" type="text" name="arangoUser" placeholder="User">
                                        <input class="dataBaseDropDownContentForm" id="arangoPass" type="password" name="arangoPass" placeholder="Password">
                                        <input class="dataBaseDropDownContentForm" id="arangoDataBase" type="text" name="arangoDataBase" placeholder="Database">
                                        <input class="dataBaseDropDownContentForm" id="arangoCollection" type="text" name="arangoCollection" placeholder="Collection">
                                        <button class="dropDownCloseButton" onclick="databaseInfoSubmit()" type='button'>Save</button>
                                    </form>
                                </div>
                                <div class="searchDropDown" style="width:8%">
                                    <button class="dropDownOpenButton" onclick="searchDropDown()">Search</button>
                                    <form method="post" id="nodeSearchFormDropDown" class="nodeSearchFormDropDown" type='button' onSubmit="return false;">
                                        <input class="nodeSearchForm" id="nodeSearchForm" type="text" name="nodeSearchForm" placeholder="Node Name">
                                        <button class="nodeSearchButton" onclick="nodeSearch()" type='button'>Search</button>
                                    </form>
                                </div>
                                <div class="btn-group" style="width:78%">
                                    <button onclick="buttonClick(0)" style="width:33.3%">SVG</button>
                                    <button onclick="buttonClick(1)" style="width:33.3%">2D Interactive</button>
                                    <button onclick="buttonClick(2)" style="width:33.3%">3D Interactive</button>
                                </div>
                                <div class="toolsDropDown" style="width:2%">
                                    <div class="toolsDropDownDots" onclick="toolsDropDownDots()">
                                        <span class="tool-dot" style="margin-top:4px"></span>
                                        <span class="tool-dot" style="margin-top:3px"></span>
                                        <span class="tool-dot" style="margin-top:3px"></span>
                                    </div>
                                    <form method="post" id="toolsFormDropDown" class="toolsFormDropDown" type='button' onSubmit="return false;">
                                        <input class="saveJsonForm" id="saveJsonForm" type="text" name="saveJsonForm" placeholder="Save as JSON" style="width:65%">
                                        <button class="saveJsonFormButton" onclick="saveJSON()" type='button'>Save</button>
                                    </form>
                                </div>
                            </div>
                            <!-- Container for graph visualization -->
                            <div class="visualization">
                                <div class="visualizationControl" id="visualizationControl">
                                    <input id="visualizationZoomer" class="visualizationZoomer" type="range">
                                </div>
                                <div id="visualizationContent" class="visualizationContent">
                                    <div class="visualizationGraphic"></div>
                                </div>
                                <div id="forceVisualizationContent" class="forceVisualizationContent">
                                    <div id="forceVisualizationGraphic" class="forceVisualizationGraphic"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
