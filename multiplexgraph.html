<!DOCTYPE html>
<html>
<!-- Displays detailed information on a single graph. Allows OCD algorithm execution. -->
<head>
    <title>OCD - Graph</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="CSS/layout.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="JS/contentHandler.js"></script>
    <script src="node_modules/js-base64/base64.js"></script>
    <script src="JS/ServiceAPI/moduleHelper.js"></script>
    <script src="JS/ServiceAPI/serviceAPI.js"></script>
    <script src="JS/requestHandler.js"></script>
    <script src="JS/graphTableHandler.js"></script>
    <script src="node_modules/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
    <script src="node_modules/jquery.panzoom/dist/jquery.panzoom.min.js"></script>
    <script src="node_modules/jquery.mousewheel/jquery.mousewheel.js"></script>
    <script src="JS/simulation/jsonRequestHandler.js"></script>
    <script src="JS/simulation/simulationForm.js"></script>
    <script src="node_modules/three/build/three.min.js"></script>
    <script src="node_modules/force-graph/dist/force-graph.min.js"></script>
    <script src="node_modules/3d-force-graph/dist/3d-force-graph.min.js"></script>
    <script src="node_modules/three/examples/js/renderers/CSS2DRenderer.js"></script>
    <script src="node_modules/arangojs/lib/web.js"></script>
    <script src="node_modules/file-saver/dist/FileSaver.min.js"></script>
    <script type="text/javascript">
        /* Id of the graph */
        var graphId = getUrlVar("id");
        /* Graph meta information in xml format */
        var graphMetaXml;
        /*  */
        var graphLayerTableRetrieved = false;
        /* Graph structure in edge list format */
        var graphProperties;

        //Testserver: http://ocd-web-client.duckdns.org:7071
        //Server ginkgo from rwth: http://ginkgo.informatik.rwth-aachen.de:8529
        const db = new arangojs.Database('http://127.0.0.1:8529');

        /* Names of all OCD algorithms */
        var multiplexAlgorithmNames;
        var algorithmNames;

        /* Executed after page loading */
        $(document).ready(function () {
            /* Identifiers for the graph information to be displayed */
            var cells = ["Name", "NodeCount", "EdgeCount", "D", "W", "Z", "N", "L", "C", "R"];
            /* Requests the graph meta information */
            sendRequest("get", "multiplexgraphs/" + graphId + "?outputFormat=MULTIPLEX_META_XML", "",
                /* Response handler */
                function (response) {
                    /* Stores graph meta information and adds it to the graph header */
                    graphMetaXml = response;
                    var name = $(graphMetaXml).find('Name').text();
                    var nodes = $(graphMetaXml).find('NodeCount').text();
                    var edges = $(graphMetaXml).find('EdgeCount').text();
                    var layers = $(graphMetaXml).find('LayerCount').text();
                    var representativeId = $(graphMetaXml).find('RepresentativeGraphKey').text();
                    /* Graph types */
                    var types = [];
                    $(graphMetaXml).children('Types').find('Type').each(function () {
                        types.push($(this).text());
                    });
                    var origin = [$(graphMetaXml).find('CreationMethod').find('Type').text(), $(graphMetaXml).find('CreationMethod').find('Type').attr('DisplayName')];

                    var description = "A";
                    if ($.inArray("DIRECTED", types) === -1 && $.inArray("WEIGHTED", types) === -1)
                        description += " simple ";
                    if ($.inArray("DIRECTED", types) > -1)
                        description += " directed ";
                    if ($.inArray("WEIGHTED", types) > -1)
                        description += " weighted ";
                    if (origin[0] !== "UNDEFINED") {
                        description += " " + origin[1] + " ";
                        if (origin[0] !== "REAL_WORLD")
                            description += " benchmark ";
                    }

                    description += ' network with ' + nodes + ' nodes and ' + edges + ' links.';

                    if($.inArray("ZERO_WEIGHTS", types) > -1 || $.inArray("NEGATIVE_WEIGHTS", types) > -1 || $.inArray("SELF_LOOPS", types) > -1) {
                        description += " The network has";
                        if ($.inArray("ZERO_WEIGHTS", types) > -1)
                            description += " zero weights,";
                        if ($.inArray("NEGATIVE_WEIGHTS", types) > -1)
                            description += " negative weights,";
                        if ($.inArray("SELF_LOOPS", types) > -1)
                            description += " self loops";
                        if(description.endsWith(","))
                            description = description.slice(0, description.length-1)
                        description += "."
                    }

                    $('#graphHeader').html(getHeadLine(name, description));
                    $('#graphCovers').html('<a href="covers.html?graphId=' + representativeId + '">Covers</a>');
                    $('#graphDelete').html('<a onclick="deleteGraph()" href="#">Delete</a>');

                    /* Registers components and event handlers */
                    //registerCollapsable("#propertiesCollapsable", propertiesCollapsableHandler);
                    registerCollapsable("#layerListCollapsable", layerListCollapsableHandler);
                    registerCollapsable("#runAlgorithmCollapsable", runAlgorithmCollapsableHandler);
                    registerCollapsable("#runMultiplexAlgorithmCollapsable", runMultiplexAlgorithmCollapsableHandler);
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("Graph was not received.", errorData);
                }, "text");

            /*
            * Run algorithm form listener.
            */
            $('#runAlgorithmForm').submit(function () {
                var multiplexAlgo = $('#multiplexalgorithm').val();
                var algo = $('#algorithm').val();
                if (multiplexAlgo !== getSelectOptionVal()) {
                    var coverName = $("#coverName").val();
                    if (coverName === "") {
                        showErrorMessage('Please define a cover name.');
                        window.scrollTo(0, 0);
                        return;
                    }
                    var multiplexParams = getParameterXml("#multiplexalgorithmParameterDiv");
                    var params = getParameterXml("#algorithmParameterDiv");

                    var jsonData = {
                        'multiplexparams': multiplexParams,
                        'params': params
                    };
                    jsonDataStr = JSON.stringify(jsonData);
        
                    buttonSubmitStart("runAlgorithmBtn");
                    
                    /* Requests an algorithm execution  */
                    sendRequest("post", "covers/multiplexgraphs/" + graphId
                        + "/algorithms?multiplexalgorithm=" + multiplexAlgo + "&algorithm=" + algo + "&name=" + coverName, jsonDataStr,
                        /* Response handler */
                        function (response) {
                            window.location.href = 'index.html';
                        },
                        /* Error handler */
                        function (errorData) {
                            /*
                             * Run algorithm request failed
                             */
                            buttonSubmitEnd("runAlgorithmBtn");
                            showConnectionErrorMessage("Algorithm request failed.", errorData);
                        });
                }
                return false;
            });
            
            /* Listener for ABACUS */
            $('#multiplexalgorithm').change(function() {
                var selectedAlgorithm = $(this).val();
                if (selectedAlgorithm === 'ABACUS_ALGORITHM') {
                    $('#ABACUS').show();
                    runAlgorithmCollapsableHandler()
                } else {
                    $('#ABACUS').hide();
                }
            });

        });    

        /* Requests the names of all OCD algorithms.
         * Then executes a callback function */
        function getAlgorithmNames(callback) {
            sendRequest("get", "algorithms", "",
                /* Response handler */
                function (response) {
                    algorithmNames = response;
                    if (typeof callback !== 'undefined') {
                        callback();
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * OCD algorithm request failed
                     */
                    showConnectionErrorMessage("Algorithm names were not received.", errorData);
                });
        }

        /* Requests the names of all multiplex OCD algorithms.
         * Then executes a callback function */
         function getMultiplexAlgorithmNames(callback) {
            sendRequest("get", "multiplexalgorithms", "",
                /* Response handler */
                function (response) {
                    multiplexAlgorithmNames = response;
                    if (typeof callback !== 'undefined') {
                        callback();
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * OCD algorithm request failed
                     */
                    showConnectionErrorMessage("Algorithm names were not received.", errorData);
                });
        }


        /* Requests all parameter names for a given algorithm.
         * Then executes a calllback function */
        function getAlgorithmParameters(algorithmName, callback) {
            sendRequest("get", "algorithms/" + algorithmName + "/parameters/default", "",
                /* Response handler */
                function (response) {
                    if (typeof callback !== 'undefined') {
                        callback(response);
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("Algorithm parameters were not received.", errorData);
                });
        }

        /* Requests all compatible graph types for a given algorithm.
         * Then executes a calllback function */
        function getAlgorithmCompatibleGraphTypes(algorithmName, callback) {
            sendRequest("get", "algorithms/" + algorithmName + "/graphTypes", "",
                /* Response handler */
                function (response) {
                    if (typeof callback !== 'undefined') {
                        callback(response);
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphTypes request failed
                     */
                    showConnectionErrorMessage("Algorithms compatible graph types were not received.", errorData);
                });
        }
        
        /* Handles the collapsable element for the algorithm execution. */
        function runMultiplexAlgorithmCollapsableHandler() {
            if (typeof multiplexAlgorithmNames === 'undefined') {
                /* Adds all algorithm names to the form */
                getMultiplexAlgorithmNames(function () {
                    $(multiplexAlgorithmNames).find('Name').each(function () {
                        if ($(this).text() !== 'UNDEFINED' && $(this).text() !== 'GROUND_TRUTH') {
                            $("#multiplexalgorithm").append(
                                '<option value="' + $(this).text()
                                + '">' + $(this).attr("displayName") + '</option>');
                        }
                    });
                });
                
                /* Registers the graph type component for the contentHandler */
                registerGraphTypes("#multiplexalgorithm", "#multiplexalgorithmGraphTypeDiv", getAlgorithmCompatibleGraphTypes);
                /* Registers the parameter component for the contentHandler */
                registerParameterSelect("#multiplexalgorithm", "#multiplexalgorithmParameterDiv", getAlgorithmParameters);
            }
        }

        /* Handles the collapsable element for the algorithm execution. */
        function runAlgorithmCollapsableHandler() {
            if (typeof algorithmNames === 'undefined') {
                /* Adds all algorithm names to the form */
                getAlgorithmNames(function () {
                    $(algorithmNames).find('Name').each(function () {
                        if ($(this).text() !== 'UNDEFINED' && $(this).text() !== 'GROUND_TRUTH') {
                            $("#algorithm").append(
                                '<option value="' + $(this).text()
                                + '">' + $(this).attr("displayName") + '</option>');
                        }
                    });
                });
                /* Registers the graph type component for the contentHandler */
                registerGraphTypes("#algorithm", "#algorithmGraphTypeDiv", getAlgorithmCompatibleGraphTypes);
                /* Registers the parameter component for the contentHandler */
                registerParameterSelect("#algorithm", "#algorithmParameterDiv", getAlgorithmParameters);
            }
        }
        

         /* Handles the collapsable element for the layer list. */
         function layerListCollapsableHandler() {
            if (!graphLayerTableRetrieved) {
                var cells =  ["Name", "NodeCount", "EdgeCount", "D", "W", "Z", "N", "L", "Co", "Cn", "CS", "R", ".txt"];
                sendRequest("get", "multiplexlayers?keyMultiplex=" + graphId, "",
                    function(GraphMetasXml) {
                        $(GraphMetasXml).find("Graph").each(function() {
                        appendLayerRow($('#graphLayerTable'), $(this), cells);
                        });
                        try {
                            $("#graphLayerTable").tablesorter({sortList: [[0,0]],
                                headers: { 4: {sorter: false}, 5: {sorter: false}, 6: {sorter: false}, 7: {sorter: false}, 8: {sorter: false},
                                    9: {sorter: false}, 10: {sorter: false}, 11: {sorter: false}, 12: {sorter: false}, 13: {sorter: false}}});
                        } catch(err) { /* table empty */ }
                        registerGraphTable();
                    },
                    /* Error handler */
                    function (errorData) {
                        /* request failed */
                        showConnectionErrorMessage("Graphs metas of multiplex layers were not received.", errorData);
                    });
                graphLayerTableRetrieved = true;
            }
        }

        function appendLayerRow(table, graphElt, cells) {
            var row = "<tr>";
            /* Graph id */
            var id = $(graphElt).find('Id').text();
            row += createGraphIdCell(id);
            /* Graph types */
            var types = [];
            $(graphElt).children('Types').find('Type').each(function() {
                types.push($(this).text());
            });
            /* Graph name  */
            if($.inArray("Name", cells) > -1) {
                row += createLayerNameCell($(graphElt).find('Name').text(), id);
            }
            /* Node count */
            if($.inArray("NodeCount", cells) > -1) {
                row += createGraphTableCell($(graphElt).find('NodeCount').text());
            }
            /* Edge count */
            if($.inArray("EdgeCount", cells) > -1) {
                row += createGraphTableCell($(graphElt).find('EdgeCount').text());
            }
            /* Directed */
            if($.inArray("D", cells) > -1) {
                row += createGraphTableCell(getGraphTrueOrFalseIcon($.inArray("DIRECTED", types) > -1));
            }
            /* Weighted */
            if($.inArray("W", cells) > -1) {
                row += createGraphTableCell(getGraphTrueOrFalseIcon($.inArray("WEIGHTED", types) > -1));
            }
            /* Zero edge weights */
            if($.inArray("Z", cells) > -1) {
                row += createGraphTableCell(getGraphTrueOrFalseIcon($.inArray("ZERO_WEIGHTS", types) > -1));
            }
            /* Negative edge weights */
            if($.inArray("N", cells) > -1) {
                row += createGraphTableCell(getGraphTrueOrFalseIcon($.inArray("NEGATIVE_WEIGHTS", types) > -1));
            }
            /* Loops */
            if($.inArray("L", cells) > -1) {
                row += createGraphTableCell(getGraphTrueOrFalseIcon($.inArray("SELF_LOOPS", types) > -1));
            }
            /* Show corresponding covers */
            if($.inArray("Co", cells) > -1) {
                row += createShowGraphCoversCell();
            }
            /* Show corresponding centralities */
            if($.inArray("Cn", cells) > -1) {
                row += createShowGraphCentralitiesCell();
            }
            /* Show corresponding cooperation simulations */
            if($.inArray("CS", cells) > -1) {
                row += createShowCooperationSimulationsCell();
            }
            /* Delete graph */
            if($.inArray("R", cells) > -1) {
                row += createGraphDeleteCell(false);
            }
            /* Save graph */
            if($.inArray(".txt", cells) > -1) {
                row += createSaveGraphCell();
            }
            /* Select graph */
            if($.inArray("Select", cells) > -1) {
                row += createSelectGraphCell(id);
            }
            row += "</tr>";
            $(table).children('tbody').append(row);
        }

        /* Creates graph name cell */
        function createLayerNameCell(name, id) {
            return '<td class="graphNameCell"><a href="graph.html?id='+ id + '">' + name + '</a></td>';
            
        }

        function deleteGraph() {
            sendRequest("delete", "multiplexgraphs/" + graphId , "",
                /* Request handler */
                function (response) {
                    showSuccess(response);
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("MultiplexGraph deletion failed.", errorData);
                });
        }
    </script>
</head>
<body>
<div id="wrapper">
    <div id="contentWrapper">
        <div id="content">
            <!-- Container for error message display -->
            <div id="errorMessageWrapper">
                <div id="errorMessage"></div>
            </div>
            <!-- Graph meta information and related data -->
            <div style="margin-bottom: 1em;">
                <div id="graphHeader" class="col-sm-12 col-md-12 graphColor">
                </div>
                <div class="side-nav d-flex flex-row">
                    <ul class="nav" style="width: 100%;">
                        <div class="p-2 coverColor col-md-3 col-sm-6">
                            <li id="graphCovers" class="nav-item coverColor"></li>
                        </div>
                        <div class="p-2 deleteColor col-md-3 col-sm-6">
                            <li id="graphDelete" class="nav-item deleteColor"></li>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="container-fluid">
                <!-- Collapsable for graph layers list -->
                <div id="layerListCollapsable" class="collapsable col-sm-12">
                    <div class="collapsableHeader">
                        <div class="collapsableTitle">Layers</div>

                        <div class="collapsableCollapser">
                            <img class="icon iconBtn collapsableDisplayBtn"
                                 src="IMG/open-iconic/svg/chevron-bottom.svg" alt="d"> <img
                                class="icon iconBtn collapsableCollapseBtn"
                                src="IMG/open-iconic/svg/chevron-top.svg" alt="c">
                        </div>
                    </div>
                    <div class="collapsableContent">
                        <!-- Table for graph layer list -->
                        <div class="tableWrapper table-responsive">
                            <table id="graphLayerTable" class = "table table-striped">
                                <thead>
                                <tr>
                                    <th  title="Graph Name" class="sortable">
                                        Name
                                        <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                    </th>
                                    <th  title="Node Count" class="sortable">
                                        Nodes
                                        <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                    </th>
                                    <th  title="Edge Count" class="sortable">
                                        Edges
                                        <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                    </th>
                                    <th width="20" title="Has Directed Edges">
                                        D
                                    </th>
                                    <th width="20" title="Has Weighted Edges">
                                        W
                                    </th>
                                    <th width="20" title="Has Zero Edge Weights">
                                        Z
                                    </th>
                                    <th width="20" title="Has Negative Edge Weights">
                                        N
                                    </th>
                                    <th width="20" title="Has Self Loops">
                                        L
                                    </th>
                                    <th width="20" title="Show Covers">
                                        Co
                                    <th width="20" title="Show Centralities">
                                        Cn
                                    </th>
                                    <th width="20" title="Show Cooperation Simulations">
                                        CS
                                    </th>
                                    <th width="20" title="Remove Graph">
                                        R
                                    </th>
                                    <th width="30" title="Save Graph">
                                        .txt
                                    </th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <!-- Collapsable for algorithm execution -->
                    <div id="runMultiplexAlgorithmCollapsable" class="collapsable col-sm-12">
                        <div class="collapsableHeader coverColor">
                            <div class="collapsableTitle">Run OCD Algorithm</div>
                            <div class="collapsableCollapser">
                                <img class="icon iconBtn collapsableDisplayBtn"
                                     src="IMG/open-iconic/svg/chevron-bottom.svg" alt="d"> <img
                                    class="icon iconBtn collapsableCollapseBtn"
                                    src="IMG/open-iconic/svg/chevron-top.svg" alt="c">
                            </div>
                        </div>
                        <div class="collapsableContent">
                            <div id="ocdContainer" class="container">
                                <form id="runAlgorithmForm"
                                      action="javascript:void(0); return false;">
                                    <!-- Cover Name -->
                                    <div class="form-group row">
                                        <label for="coverName" class="col-sm-2 col-form-label">Cover</label>
                                        <div class="col-sm-10">
                                            <input id="coverName" type="text" class="form-control"
                                                   name="name" placeholder="name">
                                        </div>
                                    </div>
                                    <!-- Algorithm -->
                                    <div class="form-group row">
                                        <label for="multiplexalgorithm" class="col-sm-2 col-form-label">Multiplex Algorithm</label>
                                        <div class="col-sm-10">
                                            <select id="multiplexalgorithm" class="form-control custom-select">
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Algorithm Graph Types -->
                                    <div class="col-sm-10" id="multiplexalgorithmGraphTypeDiv"></div>
                                    <!-- Algorithm Parameters -->
                                    <div class="col-sm-10" id="multiplexalgorithmParameterDiv"></div>
                                    <!-- Abacus -->
                                    <div id="ABACUS" style="display: none;">
                                        <div class="form-group row">
                                            <label for="algorithm" class="col-sm-2 col-form-label">Single-layer Algorithm</label>
                                            <div class="col-sm-10">
                                                <select id="algorithm" class="form-control custom-select">
                                                </select>
                                            </div>
                                        </div>
                                        <!-- Algorithm Graph Types -->
                                        <div class="col-sm-10" id="algorithmGraphTypeDiv"></div>
                                        <!-- Algorithm Parameters -->
                                        <div class="col-sm-10" id="algorithmParameterDiv"></div>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" name="submit" id="runAlgorithmBtn" class="btn btn-primary">
                                            <span class="submitText">Run</span>
                                            <span class="submitSpinner spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
