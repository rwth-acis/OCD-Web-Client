<!DOCTYPE html>
<!--
Facilitates import / upload of new graphs and covers.
-->
<html>
    <head>
        <title>OCD - Import</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="node_modules/bootstrap-multiselect/dist/css/bootstrap-multiselect.min.css">
        <link rel="stylesheet" type="text/css" href="CSS/layout.css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="//npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
        <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="JS/contentHandler.js"></script>
        <script src="node_modules/js-base64/base64.js"></script>
        <script src="JS/ServiceAPI/moduleHelper.js"></script>
        <script src="JS/ServiceAPI/serviceAPI.js"></script>
        <script src="JS/requestHandler.js"></script>
        <script src="node_modules/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
        <script src="JS/graphTableHandler.js"></script>
        <script src="node_modules/arangojs/web.js"></script>
        <script src="node_modules/bootstrap-multiselect/dist/js/bootstrap-multiselect.min.js"></script>
        <script type="text/javascript">
            /* Names of all input formats */
            var inputFormatNames;
            /* Creator/creation type of a graph / cover */
            var creatorTypes;
            /* Defaul select option value */
            var selectOptionVal = "SELECT";
            /* Graphs displayed per page (for cover upload) */
            var GRAPHS_PER_PAGE = 20;
            /* Current graph page number */
            var pageNumber = 0;
            /* Default select option code */
            var selectOptionStr = '<option value=' + selectOptionVal + '>--SELECT--</option>';

            /* Executed after page loading */
            $(document).ready(function() {
                $("#edgeCollections").multiselect({
                    buttonTextAlignment: 'left',
                    buttonWidth: '100%',
                    widthSynchronizationMode: "ifPopupIsSmaller",
                    includeSelectAllOption: true,
                    allSelectedText: 'All Edges'
                });
                /* Import form initialization */
                $("#objectType").append(
                        selectOptionStr
                        + '<option value="graph">Graph</option>'
                        + '<option value="cover">Cover</option>'
                        + '<option value="centrality">Centrality</option>'
                );
                /*
                * Import form listener.
                */
                $('#importForm').submit(function(){
                    /*
                     * Verifies input
                     */
                    if($("#objectType").val() === selectOptionVal) {
                        showErrorMessage('Please select an import option.');
                        return;
                    }
                    else if($("#objectFormat").val() === selectOptionVal) {
                        showErrorMessage('Please select an import format.');
                        return;
                    }
                    else if($("#objectName").val() === "") {
                        showErrorMessage('Please define a name.');
                        return;
                    }
                    if($("#objectType").val() === "cover") {
                        if($("#objectCreator").val() === selectOptionVal) {
                            showErrorMessage('Please select an Algorithm.');
                            return;
                        }
                        var graphId = $("input[name='graphSelect']:checked").val();
                        if(typeof graphId === 'undefined') {
                            showErrorMessage('Please select a graph.');
                            return;
                        }
                    }
                    else if($("#objectType").val() === "graph") {
                        if($("#objectCreator").val() === selectOptionVal) {
                            showErrorMessage('Please select a Benchmark.');
                            return;
                        }

                    	if($("#objectFormat").val() === 'XML' || $("#objectFormat").val() === 'NODE_CONTENT_EDGE_LIST' || $("#objectFormat").val() === 'LMS_TRIPLESTORE'){
                    		if($("#startDate").val() === ""){
                                showErrorMessage('Please enter Start Date.');
                                return;
                    		}
                    		if($("#endDate").val() === ""){
                                showErrorMessage('Please enter End Date.');
                                return;
                    		}
                    	}

                    }
                    else if($("#objectType").val() === "centrality") {
                        if($("#objectCreator").val() === selectOptionVal) {
                            showErrorMessage('Please select a Creation Method');
                            return;
                        }
                        var graphId = $("input[name='graphSelect']:checked").val();
                        if(typeof graphId === 'undefined') {
                            showErrorMessage('Please select a graph.');
                            return;
                        }
                    }
                    else {
                        /* Should not happen */
                        showErrorMessage('Client Error.');
                        return;
                    }
                    /*
                     * Verifies browser compatibility
                     */
                    if (window.File && window.FileReader && window.FileList && window.Blob) {
                        var file = $("#objectFile").get(0).files[0];

                        buttonSubmitStart("submitButton");

                        if(file) {
                            /* Reads input file */
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                var content = e.target.result;
                                if($("#objectType").val() === "graph") {
                                    /* Requests graph import */
                                    postGraph(content);
                                }
                                else if($("#objectType").val() === "cover") {
                                    /* Requests cover import */
                                    postCover(content);
                                }
                                else if($("#objectType").val() === "centrality") {
                                    /* Requests centrality import */
                                    postCentrality(content);
                                }
                                else {
									buttonSubmitEnd("submitButton");
                                    showErrorMessage("Client Error");
                                }
                            };
                            reader.readAsText(file);
                        }
                        else if($("#objectFormat").val() === 'LMS_TRIPLESTORE' || $("#objectFormat").val() === 'ARANGODB') {
                            if($("#objectType").val() === "graph") {
                                /* Requests graph import */
                                postGraph("");
                            }
                        }
                        else {
                           buttonSubmitEnd("submitButton");
                           showErrorMessage('File could not be loaded.');
                        }
                    /*
                     * Browser not compatible
                     */
                    } else {
					  buttonSubmitEnd("submitButton");
                      showErrorMessage('Your Browser does not support html file input.');
                    }
                });
                /*
                 * Object type select listener
                 */
                $("#objectType").change(function() {
                    /* Form initialization */
                    $("#objectFormat").empty();
                    $("#objectCreator").empty();
                    $(".selectorWrapper").css("display", "none");
                    $(".graphOptionsRow").css("display", "none");
                    $("#objectType option:selected").each(function() {
                        if($(this).val() !== selectOptionVal) {
                            /* Requests input format names and adds them to the form */
                            getInputFormats(function() {
                                $("#objectFormat").append(selectOptionStr);
                                $(inputFormatNames).find('Name').each(function() {
                                    if ($(this).text() === "ARANGODB" && localStorage.getItem("arangoUser@WebOCD") === null) {
                                        $("#objectFormat").append(
                                            '<option value="' + $(this).text() + ' class="arangoDBFormatOption"'
                                            + '" disabled>' + $(this).attr("displayName") + '  (LOG INTO YOUR DATABASE AT THE USERMENU TO USE THIS FEATURE)' + '</option>');
                                    }
                                    else {
                                        $("#objectFormat").append(
                                            '<option value="' + $(this).text()
                                            + '">' + $(this).attr("displayName") + '</option>');
                                    }

                                });
                            });
                            /* Loads and displays graph table to select a corresponding graph */
                            if($(this).val() === "cover" || $(this).val() === "centrality") {
                                loadGraphTable();
                                $(".selectorWrapper").css("display", "block");
                            }
                            /* Displays graph import options */
                            else if($(this).val() === "graph") {
                                $(".graphOptionsRow").css("display", "block");
                            }
                            else {
                                showErrorMessage("Client Error");
                            }
                            /* Loads and displays creator types */
                            getCreatorTypes(function() {
                                $("#objectCreator").append(selectOptionStr);
                                $(creatorTypes).find('Name').each(function() {
                                    $("#objectCreator").append(
                                        '<option value="' + $(this).text()
                                        + '">' + $(this).attr("displayName") + '</option>');
                                });
                            });
                            $("#objectCreatorRow").css("display", "block");
                        }
                        else {
                            $("#objectCreatorRow").css("display", "none");
                        }
                    });
                });
                $("#objectFormat").change(function() {
                    $("#startDateStr").addClass('hidden');
                    $("#endDateStr").addClass('hidden');
                    $("#showUserNamestr").addClass('hidden');
                    $("#involvedUserURIstr").addClass('hidden');
                    $("#objectFileDiv").removeClass('hidden');
                    $("#databaseInput").addClass('hidden');

                	if($("#objectFormat").val() === 'XML' || $("#objectFormat").val() === 'NODE_CONTENT_EDGE_LIST' || $("#objectFormat").val() === 'LMS_TRIPLESTORE' || $("#objectFormat").val() === 'ARANGODB') {
                		$("#startDateStr").removeClass('hidden');
                		$("#endDateStr").removeClass('hidden');
                        $("#objectFileDiv").removeClass('hidden');
                		if($("#objectFormat").val() === 'LMS_TRIPLESTORE') {
                            $("#showUserNamestr").removeClass('hidden');
                            $("#involvedUserURIstr").removeClass('hidden');
                            $("#objectFileDiv").addClass('hidden');
                        }
                        else if($("#objectFormat").val() === 'ARANGODB') {
                            $("#showUserNamestr").removeClass('hidden');
                            $("#databaseInput").removeClass('hidden');
                            $("#objectFileDiv").addClass('hidden');


                            populateArangoDBImportFields()
                        }
                	}
                    // !!This Code can only be used when webOCD supports edge types!!
                	// } else if($("#objectFormat").val() === 'XGMML') {
                    //     $("#startDateStr").addClass('hidden');
                    //     $("#endDateStr").addClass('hidden');
                    //     $("#keytr").removeClass('hidden');
                    //     $("#type1tr").removeClass('hidden');
                    //     $("#type2tr").removeClass('hidden');
                    //     $("#type3tr").removeClass('hidden');
                    else {
                		$("#startDateStr").addClass('hidden');
                		$("#endDateStr").addClass('hidden');
                        $("#showUserNamestr").addClass('hidden');
                        $("#involvedUserURIstr").addClass('hidden');
                        $("#objectFileDiv").removeClass('hidden');
                        $("#databaseInput").addClass('hidden');
                	}
                });
                $("#databaseName").change(function() {
                    getDatabaseCollections();
                });
            });

            function populateArangoDBImportFields() {
                let db = logInAndGetDatabase()
                let databaseAddress = localStorage.getItem("arangoAdress@WebOCD");
                let databaseUser = localStorage.getItem("arangoUser@WebOCD");
                let databasePassword = localStorage.getItem("arangoPass@WebOCD");
                db = new arangojs.Database({
                    url: databaseAddress,
                    databaseName: $("#databaseName").val(),
                    auth: { username: databaseUser, password: databasePassword },
                });

                db.listUserDatabases().then(
                    (databaseNames) => {
                        console.log(databaseNames)
                        $("#databaseName").empty()
                        for (const databaseName of databaseNames) {
                            if (databaseName !== "_system") { //Ignore system database if available. Wont have any useful collections
                                $("#databaseName").append(
                                    '<option value="' + databaseName + '" >' + databaseName + '</option>');
                            }
                        }
                        getDatabaseCollections();
                    });
            }

            function getDatabaseCollections() {
                let db = logInAndGetDatabase();
                let databaseAddress = localStorage.getItem("arangoAdress@WebOCD");
                let databaseUser = localStorage.getItem("arangoUser@WebOCD");
                let databasePassword = localStorage.getItem("arangoPass@WebOCD");
                db = new arangojs.Database({
                    url: databaseAddress,
                    databaseName: $("#databaseName").val(),
                    auth: { username: databaseUser, password: databasePassword },
                });
                //db.useBasicAuth(databaseUser, databasePassword)

                $("#nodeCollection").empty()
                $("#edgeCollections").empty()
                db.listCollections().then(
                    (collections) => {
                        document.getElementById("nodeCollection").options.length = 0
                        document.getElementById("edgeCollections").options.length = 0
                        //let edgeCollections = []
                        // Add option to simply use all edge collections
                        for (const collection of collections) {
                            if (collection.type === 3) { //i.e., if we have an edge collection
                                //edgeCollections.push(collection.name)
                                $("#edgeCollections").append(
                                    '<option value="' + collection.name + '" >' + collection.name + '</option>');
                            }
                            else {
                                $("#nodeCollection").append(
                                    '<option value="' + collection.name + '" >' + collection.name + '</option>');
                            }
                        }
                        //$("#edgeCollections").append('<option value="' + edgeCollections.toString() + '" >All Edges</option>');
                        $("#edgeCollections").multiselect("rebuild")
                        $("#edgeCollections").multiselect('selectAll', true)
                    });
            }

            function sendPostGraphRequest(restUrl, content) {
                sendRequest("post", restUrl, content,
                    /* Response handler */
                    function(response) {
                        window.location.href = 'graphs.html';
                    },
                    /* Error handler */
                    function(errorData) {
                        /*
                         * Request failed
                         */
                        buttonSubmitEnd("submitButton");
                        showConnectionErrorMessage("Graph could not be sent.", errorData);
                    });
            }

            /* Requests a graph import */
            function postGraph(content) {

                var doMakeUndirected = $('#doMakeUndirected').prop('checked');
                var restUrl = "graphs?name=" + $("#objectName").val() +
                "&creationType=" + $("#objectCreator").val()
                + "&inputFormat=" + $("#objectFormat").val()
                + "&doMakeUndirected=" + doMakeUndirected;
                if($("#objectFormat").val() === 'XML' || $("#objectFormat").val() === 'NODE_CONTENT_EDGE_LIST' || $("#objectFormat").val() === 'LMS_TRIPLESTORE' || $("#objectFormat").val() === 'ARANGODB'){
                	restUrl = restUrl + "&startDate=" + $("#startDate").val() + "&endDate=" + $("#endDate").val();
                    if($("#objectFormat").val() === 'LMS_TRIPLESTORE') {
                        if($("#showUserNames").val() !== "") {
                            restUrl = restUrl + "&showUserNames=" + $("#showUserNames").val();
                        }
                        if($("#involvedUserURIs").val() !== "") {
                            restUrl = restUrl + "&involvedUsers=" + $("#involvedUserURIs").val();
                        }
                        sendPostGraphRequest(restUrl, content)
                    } else if ($("#objectFormat").val() === 'ARANGODB') {
                        restUrl = restUrl + "&databaseAddress=" + localStorage.getItem("arangoAdress@WebOCD");
                        restUrl = restUrl + "&databaseCredentials=" + localStorage.getItem("arangoUser@WebOCD") + "," +  localStorage.getItem("arangoPass@WebOCD");
                        if($("#databaseName").val() !== "") {
                            restUrl = restUrl + "&databaseName=" + $("#databaseName").val();
                        }
                        if($("#nodeCollection").val() !== "") {
                            restUrl = restUrl + "&nodeCollectionName=" + $("#nodeCollection").val();
                        }
                        if($("#showUserNames").val() !== "") {
                            restUrl = restUrl + "&showUserNames=" + $("#showUserNames").val();
                        }
                        if($("#involvedUsers").val() !== "") {
                            restUrl = restUrl + "&involvedUsers=" + $("#involvedUsers").val();
                        }
                        if($("#databaseNodeQueryRules").childElementCount !== 0) {
                            let nodeQueriesElement = document.getElementById("databaseNodeQueryRules");
                            for (const arangoQueryElement of nodeQueriesElement.children) {
                                if (arangoQueryElement.children[0].value !== "") {
                                    restUrl = restUrl + "&nodeFilters=" + arangoQueryElement.children[0].value
                                        + ":::" + arangoQueryElement.children[1].value
                                        + ":::" + arangoQueryElement.children[2].value;
                                }
                            }
                        }
                        if($("#weighEdges").val()) {
                            restUrl = restUrl + "&weighEdges=" + $("#weighEdges").val().toString();
                        }
                        if($("#edgeCollections").val() !== null || $("#edgeCollections").val() !== []) {
                            restUrl = restUrl + "&edgeCollectionNames=" + $("#edgeCollections").val().toString();
                        }
                        if($("#databaseEdgeQueryRules").childElementCount !== 0) {
                            let edgeQueriesElement = document.getElementById("databaseEdgeQueryRules");
                            for (const arangoQueryElement of edgeQueriesElement.children) {
                                if (arangoQueryElement.children[0].value !== "") {
                                    restUrl = restUrl + "&edgeFilters=" + arangoQueryElement.children[0].value
                                        + ":::" + arangoQueryElement.children[1].value
                                        + ":::" + arangoQueryElement.children[2].value
                                        + ":::" + arangoQueryElement.children[3].value;
                                }
                            }
                        }
                        if($("#nameAttribute").val() !== "") {
                            restUrl = restUrl + "&nameAttributeName=" + $("#nameAttribute").val()
                        }
                        else {
                            restUrl = restUrl + "&nameAttributeName=name"
                        }
                        if($("#dateAttribute").val() !== "") {
                            restUrl = restUrl + "&dateAttributeName=" + $("#dateAttribute").val()
                            sendPostGraphRequest(restUrl, content)
                        }
                        else {
                            let db = logInAndGetDatabase();
                            db = db.useDatabase($("#databaseName").val());

                            let edgeDocumentsQuery = "RETURN [";
                            for (const edgeCollectionName of $("#edgeCollections").val()) {
                                edgeDocumentsQuery += "(FOR edge IN " + edgeCollectionName + " LIMIT 1 RETURN edge)[0],";
                            }
                            if (edgeDocumentsQuery.endsWith(",")) {
                                edgeDocumentsQuery = edgeDocumentsQuery.slice(0,edgeDocumentsQuery.length-1)
                            }
                            edgeDocumentsQuery += "]"
                            db.query(edgeDocumentsQuery).then((cursor) => cursor.all()).then(
                                (docs) => {
                                    let found_doc = false;
                                    let dateMap =  new Map();
                                    for (const doc of docs[0]) {
                                        if (doc !== null) {
                                            for (const key of Object.keys(doc)) {
                                                let possibleDateAttr = Date.parse(doc[key])
                                                if (!isNaN(possibleDateAttr)) {
                                                    if (!dateMap.has(key)) {
                                                        dateMap.set(key, 1);
                                                    } else {
                                                        dateMap.set(key, dateMap.get(key)+1);
                                                    }
                                                    found_doc = true;
                                                }
                                            }
                                        }
                                        if (found_doc) {
                                            break;
                                        }
                                    }
                                    if (!found_doc && ($("#startDate").val() !== "" || $("#endDate").val() !== "")) {
                                        buttonSubmitEnd("submitButton");
                                        showErrorMessage("Could not find a date attribute to use for timeframe. Dont use start/end dates or specify date attribute in advanced mode")

                                    }
                                    else {
                                        let max_occ_key = dateMap.keys().next().value
                                        for (const entry of dateMap.entries()) {
                                            if(entry.value > dateMap.get(max_occ_key)) {
                                                max_occ_key = entry.key
                                            }
                                        }
                                        restUrl = restUrl + "&dateAttributeName=" + max_occ_key
                                    }
                                    sendPostGraphRequest(restUrl, content)
                                },
                                (errorData) => { showConnectionErrorMessage(errorData) } //TODO: Make this nicer
                            )
                        }
                    }
                    else {
                        sendPostGraphRequest(restUrl, content)
                    }
                }
                else {
                    sendPostGraphRequest(restUrl, content)
                }

                // !!This Code can only be used when webOCD supports edge types!!
                // if($("#objectFormat").val() === 'XGMML') {
                //     restUrl = restUrl + "&key=" + $("#key").val() + "&type1=" + $("#type1").val() + "&type2=" + $("#type2").val() + "&type3=" + $("#type3").val()
                // }
            }
            /* Requests a cover import */
            function postCover(filecontent) {
                var graphId = $("input[name='graphSelect']:checked").val();
                sendRequest("post", "covers/graphs/" + graphId + "?name=" + $("#objectName").val() + "&creationType=" +
                                $("#objectCreator").val() + "&inputFormat=" + $("#objectFormat").val(), filecontent,
                            /* Response handler */
                            function(response) {
                                window.location.href = 'covers.html';
                            },
                            /* Error handler */
                            function(errorData) {
                                /*
                                 * Request failed
                                 */
								buttonSubmitEnd("submitButton");
                                showConnectionErrorMessage("Cover could not be sent.", errorData);
                        });
            }
            /* Requests a centrality import */
            function postCentrality(filecontent) {
                var graphId = $("input[name='graphSelect']:checked").val();
                sendRequest("post", "centrality/graphs/" + graphId + "?name=" + $("#objectName").val() + "&creationType=" +
                                $("#objectCreator").val() + "&inputFormat=" + $("#objectFormat").val(), filecontent,
                            /* Response handler */
                            function(response) {
                                window.location.href = 'centralities.html';
                            },
                            /* Error handler */
                            function(errorData) {
                                /*
                                 * Request failed
                                 */
								buttonSubmitEnd("submitButton"); 
                                showConnectionErrorMessage("Centrality could not be sent.", errorData);
                        });
            }
            /* Requests input format names.
             * Then executes a callback function. */
            function getInputFormats(callback) {
                const typeSpecifier = $("#objectType").val() !== "centrality" ? $("#objectType").val() + "s" : "centralities";
                sendRequest("get", typeSpecifier + "/formats/input", "",
                        /* Response handler */
                        function(response) {
                            inputFormatNames = response;
                            if(typeof callback !== 'undefined') {
                                callback();
                            }
                        },
                        /* Error handler */
                        function(errorData) {
                            /*
                             * Request failed
                             */
                            showConnectionErrorMessage("Input format names were not received.", errorData);
                        });
            }
            /* Requests creator type names.
             * Then executes a callback function. */
            function getCreatorTypes(callback) {
                const typeSpecifier = $("#objectType").val() !== "centrality" ? $("#objectType").val() + "s" : "centralities";
                sendRequest("get", typeSpecifier + "/creationtypes", "",
                        /* Response handler */
                        function(response) {
                            creatorTypes = response;
                            if(typeof callback !== 'undefined') {
                                callback();
                            }
                        },
                        /* Error handler */
                        function(errorData) {
                            /*
                             * Request failed
                             */
                            var errString;
                            if($("#objectType").val() === "graph") {
                                errString = "Graph creation methods were not received.";
                                showConnectionErrorMessage(errString, errorData);
                            }
                            else if($("#objectType").val() === "cover") {
                                errString = "Cover creation methods were not received.";
                                showConnectionErrorMessage(errString, errorData);
                            }
                            else {
                                // Should not happen.
                                errString = "Client Error";
                                showErrorMessage(errString);
                            }
                        });
            }
            /* Gets ArangoDB database names  */
            function getDatabaseInfo(callback) {
                let databaseUser = localStorage.getItem("arangoUser@WebOCD");
                let databasePassword = localStorage.getItem("arangoPass@WebOCD");
                db_server.useBasicAuth(databaseUser, databasePassword)
                if (db_server !== null) {
                    db_server.listUserDatabases().then(
                        (databases) => {
                            databases = response;
                            if(typeof callback !== 'undefined') {
                                callback();
                            }
                        },
                        (errorData) => {
                            /*
                             * Request failed
                             */
                            showConnectionErrorMessage("Could not get databases for user", errorData);
                        });
                }
            }

            /* Adds a database query rule element  */
            function addDatabaseQueryElement(parentId) {
                let parent = document.getElementById(parentId)
                parent.lastElementChild.lastElementChild.remove()

                let databaseQueryElement =
                    '<div class="row" style="margin-left:20px">\n' +
                    (parentId === "databaseEdgeQueryRules" ? '<input class="col-md-3 form-control databaseCollectionValue" type="text" placeholder="Collection, e.g. \'Retweets\'" style="margin-left:10px">' : '') +
                    '     <input class="col-md-3 form-control databaseDocumentAttribute" type="text" placeholder="Attribute, e.g. \'age\'" style="margin-left:10px">\n' +
                    '     <select class="col-md-1 form-control custom-select databaseDocumentAttributeComparator" style="margin-left:10px">\n' +
                    '          <option><</option>\n' +
                    '          <option>></option>\n' +
                    '          <option><=</option>\n' +
                    '          <option>>=</option>\n' +
                    '          <option>!=</option>\n' +
                    '          <option>==</option>\n' +
                    '          <option>IN</option>\n' +
                    '          <option>NOT IN</option>\n' +
                    '          <option>LIKE</option>\n' +
                    '     </select>\n' +
                    '     <input class="col-md-3 form-control databaseDocumentAttributeValue" type="text" placeholder="Some value, e.g. \'15\'" style="margin-left:10px">\n' +
                    '     <div class="col-md-1" style="margin-left:10px">\n' +
                    '         <div>\n' +
                    '             <button name="submit"  class="btn" onclick="addDatabaseQueryElement(\'' + parentId + '\')" style="background-color:#74c40f;width:30px;height:30px;margin-top:4px;padding: 3px 3px 3px 3px">\n' +
                    '                 <img class="submitIcon" src="IMG/open-iconic/svg/plus.svg" alt="Add Query" height=75% style="margin-bottom:6px">\n' +
                    '             </button>\n' +
                    '         </div>\n' +
                    '     </div>\n' +
                    '</div>';

                parent.insertAdjacentHTML('beforeend', databaseQueryElement)
            }

            function showDatabaseQueryFields(showQueryFields) {
                if(showQueryFields.checked) {
                    document.getElementById("databaseNodeQueryRules").hidden = false;
                    document.getElementById("databaseEdgeQueryRules").hidden = false;
                    document.getElementById("dateAttributeStr").hidden = false;
                }
                else {
                    document.getElementById("databaseNodeQueryRules").hidden = true;
                    document.getElementById("databaseEdgeQueryRules").hidden = true;
                    document.getElementById("dateAttributeStr").hidden = true;
                }
            }

            /* Requests graph information and displays a graph table */
            function loadGraphTable() {
                /* Table initialization */
                $('#graphTable tbody').empty();
                $('.pageNumWrapper').empty();
                $('.pageNumWrapper').append(pageNumber);
                var firstIndex = GRAPHS_PER_PAGE * pageNumber;
                /* Identifiers for the graph information to be displayed */
                var cells = ["Name", "NodeCount", "EdgeCount", "D", "W", "Z", "N", "L", "Select"];
                /* Requests the graph information */
                sendRequest("get", "graphs?executionStatuses=COMPLETED&includeMeta=TRUE&firstIndex=" + firstIndex + "&length=" + GRAPHS_PER_PAGE , "",
                    /* Response handler */
                    function(graphMetasXml) {
                        /*
                         * GraphMetas request succeeded
                         */
                        if($(graphMetasXml).find("Id").length === 0 && pageNumber > 0) {
                            pageNumber--;
                            loadGraphTable();
                        }
                        /* Adds graph information to the table */
                        $(graphMetasXml).find("Graph").each(function() {
                            appendGraphRow($('#graphTable'), $(this), cells);
                        });
                            /*
                             * Sort Table
                             */
                            try {
                                $("#graphTable").tablesorter({sortList: [[0,0]],
                                    headers: { 4: { sorter: false}, 5: {sorter: false}, 6: {sorter: false}, 7: {sorter: false},
                                        8: {sorter: false}, 9: {sorter: false}}});
                                $("#graphTable").trigger('update');
                            } catch(err) { /* table empty */ }
                    },
                    function(errorData) {
                        /*
                         * GraphIds request failed
                         */
                        showConnectionErrorMessage("Graphs metas were not received.", errorData);
                });
                /* Listeners for table page control */
                $('.pageLeft').click(function(){
                    if(pageNumber > 0) {
                        pageNumber--;
                        loadGraphTable();
                    }
                });
                $('.pageRight').click(function(){
                    pageNumber++;
                    loadGraphTable();
                });
            }
        </script>
    </head>
    <body>
        <div>
            <div id="wrapper">

                <div id="contentWrapper">
                    <div id="content">

                        <!-- Container for displaying error messages -->
                        <div id="errorMessageWrapper">
                            <div id="errorMessage"></div>
                        </div>

                        <!-- Page Header -->
                        <div class="page-header graphColor">
                          <h3>Importing</h3>
                        </div>

                        <!-- Import form -->
                        <div class="container-fluid">
                          <form id="importForm" action="javascript:void(0); return false;">
                            <div class="">
                                <!-- Import object type, i.e. cover or graph -->
                                <div class="form-group">
                                  <label for="objectType" class="col-form-label">Import</label>
                                  <select id="objectType" class="form-control custom-select"></select>
                                </div>
                                <!-- Input format -->
                                <div class="form-group">
                                  <label for="objectFormat" class="col-form-label">Format</label>
                                  <select id="objectFormat" class="form-control custom-select"></select>
                                </div>
                                <div style="margin-left: 20px; margin-right:25px">
                                    <!-- Input file -->
                                    <div id="objectFileDiv" class="form-group">
                                        <label for="objectFile" class="form-label">File</label>
                                        <input id="objectFile" type="file" class="form-control-file">
                                    </div>
                                    <div id="databaseInput" class="hidden">
                                        <!-- Input format -->
                                        <div class="row form-group">
                                            <div class="col-md-4">
                                            <label for="databaseName" class="col-form-label">Database</label>
                                            <select id="databaseName" class="form-control custom-select"></select>
                                            </div>
                                            <div class="col-md-4" style="margin-top:9px">
                                                <label class="form-check-label" for="dbImportSwitchContainer" >Advanced Mode</label>
                                                <div id="dbImportSwitchContainer" class="form-check form-switch" style="margin-top:10px">
                                                    <input class="form-check-input" type="checkbox" role="switch" onchange="showDatabaseQueryFields(this)" id="databaseImportAdvancedModeSwitch">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row border-top" style="height:1px"></div>
                                        <div class="row form-group">
                                            <div class="col-md-4">
                                                <label for="nodeCollection" class="col-form-label">Node Collection</label>
                                                <select id="nodeCollection" class="form-control custom-select"></select>
                                            </div>
                                            <div id="involvedUsersstr" class="col-md-4" >
                                                <label for="involvedUsers" class="col-form-label">Involved Node IDs</label>
                                                <input id="involvedUsers" class="form-control" type="text" placeholder="Comma separated user id list">
                                            </div>
                                        </div>
                                        <div id="databaseNodeQueryRules" hidden>
                                            <div class="row" style="margin-left:20px" >
                                                <input class="col-md-3 form-control databaseDocumentAttribute" type="text" placeholder="Attribute, e.g. 'age'" style="margin-left:10px">
                                                <select class="col-md-1 form-control custom-select databaseDocumentAttributeComparator" style="margin-left:10px">
                                                    <option><</option>
                                                    <option>></option>
                                                    <option><=</option>
                                                    <option>>=</option>
                                                    <option>!=</option>
                                                    <option>==</option>
                                                    <option>IN</option>
                                                    <option>NOT IN</option>
                                                    <option>LIKE</option>
                                                </select>
                                                <input class="col-md-3 form-control databaseDocumentAttributeValue" type="text" placeholder="Some value, e.g. '15'" style="margin-left:10px">
                                                <div class="col-md-1" style="margin-left:10px">
                                                    <div>
                                                        <button name="submit"  class="btn" onclick="addDatabaseQueryElement('databaseNodeQueryRules')" style="background-color:#74c40f;width:30px;height:30px;margin-top:4px;padding: 3px 3px 3px 3px">
                                                            <img class="submitIcon" src="IMG/open-iconic/svg/plus.svg" alt="Add Query" height=75% style="margin-bottom:6px">
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="weighEdges" class="form-label">Use Edge Weights</label>
                                            <input id="weighEdges" type="checkbox" class="form-control-checkbox">
                                        </div>
                                        <div class="row form-group">
                                            <div class="col-md-4">
                                                <label for="edgeCollections" style="width:100%; margin-top:4px">Edge Collections</label>
                                                <select id="edgeCollections" class="form-control row" multiple="multiple" style="width:inherit"></select>
                                            </div>
                                        </div>
                                        <div id="databaseEdgeQueryRules" hidden>
                                            <div class="row" style="margin-left:20px">
                                                <input class="col-md-3 form-control databaseCollectionValue" type="text" placeholder="Collection, e.g. 'Retweets'" style="margin-left:10px">
                                                <input class="col-md-3 form-control databaseDocumentAttribute" type="text" placeholder="Attribute, e.g. 'age'" style="margin-left:10px">
                                                <select class="col-md-1 form-control custom-select databaseDocumentAttributeComparator" style="margin-left:10px">
                                                    <option><</option>
                                                    <option>></option>
                                                    <option><=</option>
                                                    <option>>=</option>
                                                    <option>!=</option>
                                                    <option>==</option>
                                                    <option>IN</option>
                                                    <option>NOT IN</option>
                                                    <option>LIKE</option>
                                                </select>
                                                <input class="col-md-3 form-control databaseDocumentAttributeValue" type="text" placeholder="Some value, e.g. '15'" style="margin-left:10px">
                                                <div class="col-md-1" style="margin-left:10px">
                                                    <div>
                                                        <button name="submit"  class="btn" onclick="addDatabaseQueryElement('databaseEdgeQueryRules')" style="background-color:#74c40f;width:30px;height:30px;margin-top:4px;padding: 3px 3px 3px 3px">
                                                            <img class="submitIcon" src="IMG/open-iconic/svg/plus.svg" alt="Add Query" height=75% style="margin-bottom:6px">
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row border-top" style="height:1px;margin-top:5px"></div>
                                        <div class="row">
                                            <!-- Input Date attribute -->
                                            <div id="dateAttributeStr" class="col-md-auto" hidden>
                                                <label for="dateAttribute" class="col-form-label">Date Attribute to use to determine timeframe (leave unedited if unsure):</label>
                                                <input id="dateAttribute" class="form-control" type="text">
                                            </div>
                                        </div>
                                    </div>
                                    <div id="dateRow" class="row" >
                                        <!-- Input Start Date -->
                                        <div id="startDateStr" class="hidden col-md-auto">
                                          <label for="startDate" class="col-form-label">Start Date:</label>
                                          <input id="startDate" class="form-control" type="date">
                                        </div>
                                        <!-- Input End Date -->
                                        <div id="endDateStr" class="hidden col-md-auto">
                                          <label for="endDate" class="col-form-label">End Date:</label>
                                          <input id="endDate" class="form-control" type="date">
                                        </div>
                                    </div>
                                    <div>
                                        <div class="row">
                                        <div id="involvedUserURIstr" class="hidden col-md-9" >
                                            <label for="involvedUserURIs" class="col-form-label">Involved User URIs:</label>
                                            <input id="involvedUserURIs" class="form-control" type="text" placeholder="Comma separated uri list">
                                        </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div id="showUserNamestr" class="hidden col-auto">
                                            <label for="showUserNames" class="col-form-label" style="display:inline-block">Use names as node labels:</label>
                                            <input id="showUserNames" class="form-control-checkbox" type="checkbox" placeholder="false" role="switch" style="display:inline-block">
                                        </div>
                                        <div id="nameAttributeStr" class="col-md-auto" hidden>
                                            <label for="nameAttribute" class="col-form-label">Name Attribute to use to determine timeframe (leave unedited if unsure):</label>
                                            <input id="nameAttribute" class="form-control" type="text">
                                        </div>
                                    </div>
                                      <!-- !!!These parts can only be used once edge types are really supported in webOCD!!!
                                      <div id="keytr" class="hidden">
                                          <label for="key" class="col-form-label">Key:</label>
                                          <input id="key" type="text" value="" placeholder="empty">
                                      </div>
                                      <div id="type1tr" class="hidden">
                                          <label for="type1" class="col-form-label">Type 1:</label>
                                          <input id="type1" type="text" value="" placeholder="empty">
                                      </div>
                                      <div id="type2tr" class="hidden">
                                          <label for="type2" class="col-form-label">Type 2:</label>
                                          <input id="type2" type="text" value="" placeholder="empty">
                                      </div>
                                      <div id="type3tr" class="hidden">
                                          <label for="type3" class="col-form-label">Type 3:</label>
                                          <input id="type3" type="text" value="" placeholder="empty">
                                      </div> -->
                                    <!-- Name for imported object -->
                                </div>
                                <div class="form-group">
                                  <label for="objectName" class="col-form-label">Name</label>
                                  <input id="objectName" type="text" class="form-control">
                                </div>
                                <!-- Object creator type -->
                                <div id="objectCreatorRow" class="form-group hidden">
                                  <label for="objectCreator" class="col-form-label">Creation Method</label>
                                  <select id="objectCreator" class="form-control custom-select"></select>
                                </div>
                                <!-- Graph import options (i.e. making graphs undirected) -->
                                <div class="form-check graphOptionsRow hidden">
                                  <label for="doMakeUndirected" class="form-check-label">
                                  <input type="checkbox" class="form-check-input" id="doMakeUndirected">
                                    make undirected
                                  </label>
                                </div>
                                <!-- Form submit -->
                                <div class="submitWrapper form-group">
                                  <button id="submitButton" type="submit" name="submit" class="btn btn-primary">
                                      <span class="submitText">Submit</span>
                                      <span class="submitSpinner spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
                                  </button>
                                </div>

                              </div>
                              <!-- Graph selector for choosing a corresponding graph for cover import -->
                              <div class="selectorWrapper hidden">
                                <div class="selectorTitle">
                                    Select a Graph
                                </div>
                                        <div class="selectorContent">
                                            <!-- Graph table page control -->
                                            <div class = "card">
                                                <div class="pageControl">
                                                    <div class="pageLeftWrapper">
                                                        <img class="icon iconBtn pageLeft" src="IMG/open-iconic/svg/chevron-left.svg" alt="r">
                                                    </div>
                                                    <div class = "pageNumWrapper">
                                                    </div>
                                                    <div class="pageRightWrapper">
                                                        <img class="icon iconBtn pageRight" src="IMG/open-iconic/svg/chevron-right.svg" alt="r">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Graph table -->
                                            <div class="tableWrapper">
                                                <table id="graphTable">
                                                    <thead>
                                                    <tr>
                                                        <th class="hidden" title="Id"></th>
                                                        <th width="300" title="Graph Name" class="sortable">
                                                            Name
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="120" title="Node Count" class="sortable">
                                                            Nodes
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="120" title="Edge Count" class="sortable">
                                                            Edges
                                                            <img class="icon iconBtn" src="IMG/open-iconic/svg/sort-ascending.svg" alt="d">
                                                        </th>
                                                        <th width="20" title="Has Directed Edges">
                                                            D
                                                        </th>
                                                        <th width="20" title="Has Weighted Edges">
                                                            W
                                                        </th>
                                                        <th width="20" title="Has Zero Edge Weights">
                                                            Z
                                                        </th>
                                                        <th width="20" title="Has Negative Edge Weights">
                                                            N
                                                        </th>
                                                        <th width="20" title="Has Self Loops">
                                                            L
                                                        </th>
                                                        <th width="20" title="Select Graph">
                                                            Select
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
