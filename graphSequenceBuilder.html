<!DOCTYPE html>
<html>
<!-- Displays basic / meta information on multiple graph sequences -->
<head>
    <title>OCD - Graphs</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="CSS/layout.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="JS/contentHandler.js"></script>
    <script src="node_modules/js-base64/base64.js"></script>
    <script src="JS/ServiceAPI/moduleHelper.js"></script>
    <script src="JS/ServiceAPI/serviceAPI.js"></script>
    <script src="JS/requestHandler.js"></script>
    <script src="node_modules/jquery-ui/dist/jquery-ui.min.js/"></script>
    <script src="node_modules/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
    <script src="JS/graphSequenceTableHandler.js"></script>
    <script src="node_modules/arangojs/web.js"></script>
    <script type="text/javascript">
        /* Executed after page loading */
        $(document).ready(function() {
            sendRequest("get", "graphs?executionStatuses=COMPLETED&includeMeta=TRUE&firstIndex=0", "",
                /* Response handler */
                function(graphMetasXml) {
                    $(graphMetasXml).find("Graph").each(function() {
                        const graphId = $(this).find('Id').text();
                        const graphName = $(this).find('Name').text();
                        let graphDatesString = ""
                        if ($(this).find('StartDate').text() !== "") {
                            graphDatesString += "<br>("
                                + new Date($(this).find('StartDate').text()).toLocaleDateString('en-EN', {year: 'numeric', month: 'numeric', day: 'numeric'})
                                + "-"
                                + new Date($(this).find('EndDate').text()).toLocaleDateString('en-EN', {year: 'numeric', month: 'numeric', day: 'numeric'})
                                + ")"
                        }
                        document.getElementById("dragDropGraphs").insertAdjacentHTML("beforeend",
                            "<p class='dragDrop-drag' value='" + graphId + "' style='display: table'>" +
                            "<a class='btn btn-light' style='display: table-cell' value='" + graphId + "'>" + graphName + graphDatesString + "</a>" +
                            "<button type='button' class='btn btn-default btn-xs dragDropRemove' style='display: table-cell' " +
                                "onclick='removeFromSortable($(this).parent())' hidden><img src='IMG/open-iconic/svg/trash.svg'/></button>" +
                            "</p>")
                    });

                    initializeDragDrop();
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("Graph Metass were not received.", errorData);
                }, "text");
            });

        function removeFromSortable(elem) {
            document.getElementById("dragDropGraphs").querySelector("p[value='" + elem.attr("value") + "']").hidden = false;
            elem.detach();
        }

        /* Code for the graph builder drag&drop */
        function initializeDragDrop() {
            $('.dragDrop-drag').draggable({
                connectToSortable: '#dragDropDropzone',
                //appendTo: 'body',
                helper: 'clone',
                //revert: 'invalid'
            });

            $('#dragDropDropzone')
                .droppable({
                    activeClass: 'dragDrop-active',
                    hoverClass: 'dragDrop-hover',
                    //accept: ":not(.ui-sortable-helper)", // Reject clones generated by sortable
                    drop: function (e, ui) {
                        document.getElementById("dragDropGraphs").querySelector("p[value='" + ui.draggable.attr("value") + "']").hidden = true
                    }
                })
                .sortable({
                    //items: '.dragDrop-drop-item',
                    //revert: true,
                    sort: function() {
                        // gets added unintentionally by droppable interacting with sortable
                        // using connectWithSortable fixes this, but doesn't allow you to customize active/hoverClass options
                        $( this ).removeClass( "dragDrop-active" );
                    },
                    update: function( event, ui ) {
                        ui.item.find(".dragDropRemove").attr("hidden", false)
                    }
                });
        }

        function saveSequence() {
            let customGraphKeys = [];
            document.getElementById('dragDropDropzone').querySelectorAll("p").forEach(function(elem, currentIndex, listObj) {
                console.log(elem, currentIndex, listObj)
                customGraphKeys.push(elem.getAttribute("value"))
            });
            let sequenceName = document.getElementById("sequenceNameInput").value;
            console.log(customGraphKeys.toString())
            sendRequest("post", "sequences?graphIds=" + customGraphKeys.toString()+ "&sequenceName=" + sequenceName, "",
                function (response) {
                    var newUrl = "graphSequences.html?page=0";
                    window.location.href = newUrl;
                },
                function (errorData) {
                    showConnectionErrorMessage("Could not create sequence:", errorData)
                }, "text");
        }
    </script>
</head>
<body>
<div id="wrapper">
    <div id="contentWrapper">
        <div id="content" style="margin:auto">
            <!-- Container for displaying error messages -->
            <div id="errorMessageWrapper">
                <div id="errorMessage"></div>
            </div>
            <!-- Drag&Drop to create Sequences -->
            <div class="container">
                <h5>Sequence Builder</h5>
                <div class="row">
                    <form class="col-md-4" role="form" style="float:left">
                        <div class="form-group">
                            <input id="sequenceNameInput" class="form-control" type="text" name="name" placeholder="Sequence Name" />
                        </div>
                    </form>
                    <button class="col-auto btn btn-primary" style="float:right; height:fit-content" onclick="saveSequence()">Save</button>
                </div>
                <div class="row">
                    <div class="col-sm-6">
                        <span style="margin-left:2px; padding-bottom:5px">Graphs possible for Sequence</span>
                        <div id="dragDropGraphs"></div>
                    </div>
                    <div class="col-sm-6">
                        <span style="margin-left:2px; padding-bottom:5px">Sequence</span>
                        <ul id="dragDropDropzone" class="list-group list-group-flush"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
