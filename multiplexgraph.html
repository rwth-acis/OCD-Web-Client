<!DOCTYPE html>
<html>
<!-- Displays detailed information on a single graph. Allows OCD algorithm execution. -->
<head>
    <title>OCD - Graph</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="CSS/layout.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="JS/contentHandler.js"></script>
    <script src="node_modules/js-base64/base64.js"></script>
    <script src="JS/ServiceAPI/moduleHelper.js"></script>
    <script src="JS/ServiceAPI/serviceAPI.js"></script>
    <script src="JS/requestHandler.js"></script>
    <script src="JS/graphTableHandler.js"></script>
    <script src="node_modules/tablesorter/dist/js/jquery.tablesorter.min.js"></script>
    <script src="node_modules/jquery.panzoom/dist/jquery.panzoom.min.js"></script>
    <script src="node_modules/jquery.mousewheel/jquery.mousewheel.js"></script>
    <script src="JS/simulation/jsonRequestHandler.js"></script>
    <script src="JS/simulation/simulationForm.js"></script>
    <script src="node_modules/three/build/three.min.js"></script>
    <script src="node_modules/force-graph/dist/force-graph.min.js"></script>
    <script src="node_modules/3d-force-graph/dist/3d-force-graph.min.js"></script>
    <script src="node_modules/three/examples/js/renderers/CSS2DRenderer.js"></script>
    <script src="node_modules/arangojs/lib/web.js"></script>
    <script src="node_modules/file-saver/dist/FileSaver.min.js"></script>
    <script type="text/javascript">
        /* Id of the graph */
        var graphId = getUrlVar("id");
        /* Graph meta information in xml format */
        var graphMetaXml;
        /* Graph structure in edge list format */
        var graphProperties;
        /* Graph structure in JSON format */
        var jsonGraph;
        var forceGraph;
        var have3D;
        var haveNodeNames = false;
        var nodeName = "";
        var keysPressed = new Map();

        /* Database Information */
        var arangoUser = localStorage.getItem("arangoUser@WebOCD");
        var arangoPass = localStorage.getItem("arangoPass@WebOCD");
        var arangoDataBase = localStorage.getItem("arangoDataBase@WebOCD");
        var arangoCollection = localStorage.getItem("arangoCollection@WebOCD");

        //Testserver: http://ocd-web-client.duckdns.org:7071
        //Server ginkgo from rwth: http://ginkgo.informatik.rwth-aachen.de:8529
        const db = new arangojs.Database('http://127.0.0.1:8529');

        /* Graph visualization in SVG format */
        var highlightNodes = new Set();
        var highlightLinks = new Set();
        var rightClickNode = null;
        var rightClickLink = null;

        var visualization;
        /* Names of all OCD algorithms */
        var algorithmNames;
        /* Names of all centrality measures */
        var centralityMeasureNames;
        /* Names of all centrality simulations */
        var centralitySimulationNames;
        /* Principal eigenvalue of the grapph's adjacency matrix */
        var eigenvalue;
        /* Executed after page loading */
        $(document).ready(function () {
            /* Identifiers for the graph information to be displayed */
            var cells = ["Name", "NodeCount", "EdgeCount", "D", "W", "Z", "N", "L", "C", "R"];
            /* Requests the graph meta information */
            sendRequest("get", "multiplexgraphs/" + graphId + "?outputFormat=MULTIPLEX_META_XML", "",
                /* Response handler */
                function (response) {
                    /* Stores graph meta information and adds it to the graph header */
                    graphMetaXml = response;
                    var name = $(graphMetaXml).find('Name').text();
                    var nodes = $(graphMetaXml).find('NodeCount').text();
                    var edges = $(graphMetaXml).find('EdgeCount').text();
                    //var layers = $(graphMetaXml).find('LayerCount').text();
                    /* Graph types */
                    var types = [];
                    $(graphMetaXml).children('Types').find('Type').each(function () {
                        types.push($(this).text());
                    });
                    var origin = [$(graphMetaXml).find('CreationMethod').find('Type').text(), $(graphMetaXml).find('CreationMethod').find('Type').attr('DisplayName')];

                    var description = "A";
                    if ($.inArray("DIRECTED", types) === -1 && $.inArray("WEIGHTED", types) === -1)
                        description += " simple ";
                    if ($.inArray("DIRECTED", types) > -1)
                        description += " directed ";
                    if ($.inArray("WEIGHTED", types) > -1)
                        description += " weighted ";
                    if (origin[0] !== "UNDEFINED") {
                        description += " " + origin[1] + " ";
                        if (origin[0] !== "REAL_WORLD")
                            description += " benchmark ";
                    }

                    description += ' network with ' + nodes + ' nodes and ' + edges + ' links.';

                    if($.inArray("ZERO_WEIGHTS", types) > -1 || $.inArray("NEGATIVE_WEIGHTS", types) > -1 || $.inArray("SELF_LOOPS", types) > -1) {
                        description += " The network has";
                        if ($.inArray("ZERO_WEIGHTS", types) > -1)
                            description += " zero weights,";
                        if ($.inArray("NEGATIVE_WEIGHTS", types) > -1)
                            description += " negative weights,";
                        if ($.inArray("SELF_LOOPS", types) > -1)
                            description += " self loops";
                        if(description.endsWith(","))
                            description = description.slice(0, description.length-1)
                        description += "."
                    }

                    $('#graphHeader').html(getHeadLine(name, description));
                    $('#graphCovers').html('<a href="covers.html?graphId=' + graphId + '">Covers</a>');
                    $('#graphDelete').html('<a onclick="deleteGraph()" href="#">Delete</a>');

                    /* Registers components and event handlers */
                    //registerCollapsable("#propertiesCollapsable", propertiesCollapsableHandler);
                    //registerCollapsable("#edgeListCollapsable", edgeListCollapsableHandler);
                    registerCollapsable("#runAlgorithmCollapsable", runAlgorithmCollapsableHandler);
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("Graph was not received.", errorData);
                }, "text");

            /*
            * Run algorithm form listener.
            */
            $('#runAlgorithmForm').submit(function () {
                var algo = $('#algorithm').val();
                if (algo !== getSelectOptionVal()) {
                    var params = getParameterXml("#algorithmParameterDiv");
                    var coverName = $("#coverName").val();
                    var contentWeighting = $("#contentWeighting").is(':checked');
                    if (coverName === "") {
                        showErrorMessage('Please define a cover name.');
                        window.scrollTo(0, 0);
                        return;
                    }

                    buttonSubmitStart("runAlgorithmBtn");

                    /* Requests an algorithm execution  */
                    sendRequest("post", "covers/graphs/" + graphId
                        + "/algorithms?algorithm=" + algo + "&name=" + coverName + "&contentWeighting=" + contentWeighting, params,
                        /* Response handler */
                        function (response) {
                            window.location.href = 'index.html';
                        },
                        /* Error handler */
                        function (errorData) {
                            /*
                             * Run algorithm request failed
                             */
                            buttonSubmitEnd("runAlgorithmBtn");
                            showConnectionErrorMessage("Algorithm request failed.", errorData);
                        });
                }
                return false;
            });
        });    

        /* Requests the names of all OCD algorithms.
         * Then executes a callback function */
        function getAlgorithmNames(callback) {
            sendRequest("get", "algorithms", "",
                /* Response handler */
                function (response) {
                    algorithmNames = response;
                    if (typeof callback !== 'undefined') {
                        callback();
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * OCD algorithm request failed
                     */
                    showConnectionErrorMessage("Algorithm names were not received.", errorData);
                });
        }

        /* Requests all parameter names for a given algorithm.
         * Then executes a calllback function */
        function getAlgorithmParameters(algorithmName, callback) {
            sendRequest("get", "algorithms/" + algorithmName + "/parameters/default", "",
                /* Response handler */
                function (response) {
                    if (typeof callback !== 'undefined') {
                        callback(response);
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("Algorithm parameters were not received.", errorData);
                });
        }

        /* Requests all compatible graph types for a given algorithm.
         * Then executes a calllback function */
        function getAlgorithmCompatibleGraphTypes(algorithmName, callback) {
            sendRequest("get", "algorithms/" + algorithmName + "/graphTypes", "",
                /* Response handler */
                function (response) {
                    if (typeof callback !== 'undefined') {
                        callback(response);
                    }
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphTypes request failed
                     */
                    showConnectionErrorMessage("Algorithms compatible graph types were not received.", errorData);
                });
        }

        
        /* Handles the collapsable element for the algorithm execution. */
        function runAlgorithmCollapsableHandler() {
            if (typeof algorithmNames === 'undefined') {
                /* Adds all algorithm names to the form */
                getAlgorithmNames(function () {
                    $(algorithmNames).find('Name').each(function () {
                        if ($(this).text() !== 'UNDEFINED' && $(this).text() !== 'GROUND_TRUTH') {
                            $("#algorithm").append(
                                '<option value="' + $(this).text()
                                + '">' + $(this).attr("displayName") + '</option>');
                        }
                    });
                });
                /* Registers the graph type component for the contentHandler */
                registerGraphTypes("#algorithm", "#algorithmGraphTypeDiv", getAlgorithmCompatibleGraphTypes);
                /* Registers the parameter component for the contentHandler */
                registerParameterSelect("#algorithm", "#algorithmParameterDiv", getAlgorithmParameters);
            }
        }

        /* Handles what happens on the visualization type Button presses */
        function buttonClick(number) {
            $(document).ready(function () {

                let svgVizScroll = document.getElementById("visualizationZoomer");
                let svgViz = document.getElementById("visualizationContent");
                let forceViz = document.getElementById("forceVisualizationContent");

                highlightNodes = new Set();
                highlightLinks = new Set();

                if (number === 0) {
                    forceViz.style.display = "none";

                    svgViz.style.display = "inherit";
                    svgVizScroll.style.display = "inline";
                } else if (number === 1 || number === 2) {
                    forceViz.style.display = "inherit";
                    if (typeof forceGraph !== "undefined") {
                        forceGraph.width($('.forceVisualizationContent').width());
                        forceGraph.height($('.forceVisualizationContent').height());
                    }
                    svgViz.style.display = "none";
                    svgVizScroll.style.display = "none";

                    if (number === 1 && (have3D === true || typeof have3D === "undefined")) {
                        have3D = false;
                        //console.log("2D");
                        if (typeof forceGraph !== "undefined") {
                            forceGraph._destructor();
                        }
                        getJSON();
                    } else if (number === 2 && (have3D === false || typeof have3D === "undefined")) {
                        have3D = true;
                        //console.log("3D");
                        if (typeof forceGraph !== "undefined") {
                            forceGraph._destructor();
                        }
                        getJSON();
                    }
                }
            })
        }

        /* Listener for Ctrl+C presses */
        document.addEventListener('keydown', (e) => {
            if(e.code === "KeyC" || e.code === "ControlLeft") {
                keysPressed.set(e.code,true);
            }
        });

        /* Opens the tool bar(s) */
        function toolsDropDownDots() {
            // Close other menus
            let dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
            let i;
            for (i = 0; i < dropdowns.length; i++) {
                let openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
            dropdowns = document.getElementsByClassName("nodeSearchFormDropDown");
            for (i = 0; i < dropdowns.length; i++) {
                let openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }

            document.getElementById("toolsFormDropDown").classList.toggle("show");
        }

        function databaseInfoSubmit() {
            arangoUser = $("#arangoUser").val();
            arangoPass = $("#arangoPass").val();
            arangoDataBase = $("#arangoDataBase").val();
            arangoCollection = $("#arangoCollection").val();

            localStorage.setItem("arangoUser@WebOCD",arangoUser);
            localStorage.setItem("arangoPass@WebOCD",arangoPass);
            localStorage.setItem("arangoDataBase@WebOCD",arangoDataBase);
            localStorage.setItem("arangoCollection@WebOCD",arangoCollection);

            var dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }

        // Close the dropdown menu if the user clicks outside of it
        window.onclick = function(event) {
            if (!event.target.matches('.dropDownOpenButton') && !event.target.matches('.dataBaseDropDownContentForm') && !event.target.matches('.nodeSearchForm') && !event.target.matches('.nodeSearchButton')
                && !event.target.matches('.toolsDropDownDots')  && event.target.className !== 'tool-dot' && !event.target.matches('.saveJsonForm') && !event.target.matches('.nodeNameDisplayButton')){

                var dropdowns = document.getElementsByClassName("dataBaseDropDownContent");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
                dropdowns = document.getElementsByClassName("nodeSearchFormDropDown");
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
                dropdowns = document.getElementsByClassName("toolsFormDropDown");
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        /* Save the Graph in JSON format */
        function saveJSON() {
            let fileName = $("#saveJsonForm").val();

            if(typeof jsonGraph === 'undefined') {
                sendRequest("get", "visualization/graph/" + graphId + "/outputFormat/JSON/layout/ORGANIC", "",
                    function (response) {
                        jsonGraph = response;
                        const blob = new Blob([jsonGraph],
                            { type: "application/json" });
                        saveAs(blob, fileName + ".json");
                    });
            }
            else {
                const blob = new Blob([jsonGraph],
                    { type: "application/json" });
                saveAs(blob, fileName + ".json");
            }

            let  dropdowns = document.getElementsByClassName("toolsFormDropDown");
            for (let i = 0; i < dropdowns.length; i++) {
                let openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }

        function deleteGraph() {
            sendRequest("delete", "graphs/" + graphId, "",
                /* Request handler */
                function (response) {
                    showSuccess(response);
                },
                /* Error handler */
                function (errorData) {
                    /*
                     * GraphIds request failed
                     */
                    showConnectionErrorMessage("Graph deletion failed.", errorData);
                });
        }
    </script>
</head>
<body>
<div id="wrapper">
    <div id="contentWrapper">
        <div id="content">
            <!-- Container for error message display -->
            <div id="errorMessageWrapper">
                <div id="errorMessage"></div>
            </div>
            <!-- Graph meta information and related data -->
            <div style="margin-bottom: 1em;">
                <div id="graphHeader" class="col-sm-12 col-md-12 graphColor">

                </div>
                <div class="side-nav d-flex flex-row">
                    <ul class="nav" style="width: 100%;">
                        <div class="p-2 coverColor col-md-3 col-sm-6">
                            <li id="graphCovers" class="nav-item coverColor"></li>
                        </div>
                        <div class="p-2 deleteColor col-md-3 col-sm-6">
                            <li id="graphDelete" class="nav-item deleteColor"></li>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row">
                    <!-- Collapsable for algorithm execution -->
                    <div id="runAlgorithmCollapsable" class="collapsable col-sm-12">
                        <div class="collapsableHeader coverColor">
                            <div class="collapsableTitle">Run OCD Algorithm</div>
                            <div class="collapsableCollapser">
                                <img class="icon iconBtn collapsableDisplayBtn"
                                     src="IMG/open-iconic/svg/chevron-bottom.svg" alt="d"> <img
                                    class="icon iconBtn collapsableCollapseBtn"
                                    src="IMG/open-iconic/svg/chevron-top.svg" alt="c">
                            </div>
                        </div>
                        <div class="collapsableContent">
                            <div id="ocdContainer" class="container">
                                <form id="runAlgorithmForm"
                                      action="javascript:void(0); return false;">
                                    <!-- Cover Name -->
                                    <div class="form-group row">
                                        <label for="coverName" class="col-sm-2 col-form-label">Cover</label>
                                        <div class="col-sm-10">
                                            <input id="coverName" type="text" class="form-control"
                                                   name="name" placeholder="name">
                                        </div>
                                    </div>
                                    <!-- Algorithm -->
                                    <div class="form-group row">
                                        <label for="algorithm" class="col-sm-2 col-form-label">Algorithm</label>
                                        <div class="col-sm-10">
                                            <select id="algorithm" class="form-control custom-select">
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Algorithm Graph Types -->
                                    <div class="col-sm-10" id="algorithmGraphTypeDiv"></div>
                                    <!-- Algorithm Parameters -->
                                    <div class="col-sm-10" id="algorithmParameterDiv"></div>

                                    <div class="form-group row">
                                        <div class="container">
                                            <label class="custom-control custom-checkbox"> <input
                                                    id="contentWeighting" type="checkbox"
                                                    class="custom-control-input"> <span
                                                    class="custom-control-indicator"></span> <span
                                                    class="custom-control-label">Content Weighting</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" name="submit" id="runAlgorithmBtn" class="btn btn-primary">
                                            <span class="submitText">Run</span>
                                            <span class="submitSpinner spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
